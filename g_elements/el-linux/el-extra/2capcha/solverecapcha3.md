# Решить ReCapcha v3

![](<../../../.gitbook/assets/image (745).png>)

Элемент решает капчу формата reCAPTCHA v3. Это вид капчи от Google, который основан на рейтинге "человечности" пользователя и не требует от пользователя выполнения каких-либо заданий.

Во многом новый вид капчи похож на reCAPTCHA v2, т.е. основной принцип остался тем же - пользователь получает от API reCAPTCHA токен, который отправляется в POST-запросе к сайту, а сайт верифицирует токен через API reCAPTCHA. Но при верификации токена API reCAPTCHA теперь возвращает рейтинг "человечности" пользователя - _score_ - число от 0.1 до 0.9. Получив это значение, сайт решает, как обрабатывать запрос.

Кроме того, появился новый параметр _action_, который позволяет по разному обрабатывать различные действия пользователя на сайте. При верификации токена API reCAPTCHA вернет имя действия, которое выполнил пользователь.

Как решать reCAPTCHA v3:

1.  В первую очередь нужно убедиться, что на сайте действительно используется reCAPTCHA v3.

    Основные признаки v3:\


    * не видна пользователю, не требует кликать по картинкам;
    * скрипт api.js загружается с параметром _render=sitekey_, например:\
      _https://www.google.com/recaptcha/api.js?render=6LfZil0UAAAAAAdm1Dpzsw9q0F11-bmervx9g5fE_
    * в массиве clients конфигурационного объекта \_\_\_grecaptcha\_cfg используется индекс 100000: _\_\_\_grecaptcha\_cfg.clients\[100000]_
2.  Для решения V3 необходимо найти значения трех параметров:\


    **sitekey** - его можно найти в html в значении параметра _render_ при загрузке api.js, в параметре _k_ в URI iframe, в который подгружается reCAPTCHA, либо в javscript, в вызове функции grecaptcha.execute или в конфигурационном объекте \_\_\_grecaptcha\_cfg.

    **action** - это значение нужно искать в javascript коде сайта в вызове функции grecaptcha.execute. Пример: _grecaptcha.execute('6LfZil0UAAAAAAdm1Dpzsw9q0F11-bmervx9g5fE', {action: do\_something})_.\
    Иногда найти его достаточно сложно и требуется перевернуть вверх дном все js-файлы, подгружаемые сайтом. Кроме того, можно попробовать найти значение action в конфигурационном объекте \_\_\_grecaptcha\_cfg, но очень часто оно может быть не задано там, а передаваться только при вызове grecaptcha.execute - поэтому наиболее эффективный метод - просмотр javascript кода.\


    **pageurl** - полный URL страницы, где вы хотите решить reCAPTCHA V3.

    Кроме того, нужно понять, какое значение score вам требуется. Определить извне, при каком score сайт решит, что вы человек и пропустит ваш запрос, можно только экспериментально. Самый низкий рейгинг 0.1 - робот, а самый высокий 0.9 - человек. Но, многие сайты ставят пороговые значения от 0.2 до 0.5, т.к. обычный человек зачастую получает довольно низкий рейтинг.&#x20;
3.  После получения токена, нужно корректно использовать его на сайте. Лучший метод понять, как это сделать - посмотреть на то, какие запросы отправляются на сайт, когда вы работаете с ним как обычный посетитель. Большинство браузеров позволяют легко это сделать в консоли разработчика, нужная вкладка обычно называется "Network".

    Токен обычно отправляется в параметрах POST-запроса, это может быть _g-recaptcha-response_ как у reCAPTCHA V2, _g-recaptcha-response-100000_ или какой-либо другой параметр. Поэтому нужно внимательно просмотреть параметры запроса и найти, как именно передается токен, а затем сформировать аналогичный запрос.




## Начальные условия

1. [Установите](https://docs.primo-rpa.ru/primo-rpa/primo-rpa-studio-linux/projects/manage-dependencies#menedzher-zavisimostei) пакет Primo.2Captcha.Linux в Primo RPA Studio версии 1.24.8.2 и выше.
1. Зарегистрируйтесь на сайте https://2captcha.com, чтобы получить ключ API и указать его в одноименном свойстве элемента. Учтите, что сервис платный.

![](<../../../../.gitbook/assets1/linux_items-extra/2captcha-api-key.png>)



## Свойства
Описание общих свойств элемента см. в разделе [Свойства элемента](https://docs.primo-rpa.ru/primo-rpa/primo-studio/process/elements#svoistva-elementa).\
Символ `*` в названии свойства указывает на обязательность заполнения.

1. **Ключ сайта\*** | String | Ключ капчи reCapcha.
1. **URL\***        | String | URL сайта капчи.
1. **Ключ API\***   | String | Ключ API.
1. **URL API\***    | String | URL API.
1. **Точность**   | [Double](https://learn.microsoft.com/ru-ru/dotnet/api/system.double?view=net-5.0&viewFallbackFrom=windowsdesktop-3.0) | Необходимая точность.
1. **Тайм-аут**   | Int32  | Тайм-аут.
1. **Результат**  | String | Результат разбора капчи.



