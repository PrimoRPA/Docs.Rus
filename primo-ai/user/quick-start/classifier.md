# Работа с классификатором документов

В данном разделе вы узнаете, как работать со встроенным проектом Classifier. Проект предназначен для работы с моделью классификации документов или, иначе, *моделью-классификатором*. Данная модель будет полезна, если пользователь хранит у себя смешанные изображения документов и хочет автоматически распределить их по типам перед тем, как перейти к распознаванию данных в едином типе документов. 

## Ожидаемый результат 
Обученная модель должна уметь определять 3 типа документов: 
* паспорт;
* СНИЛС;
* Торг-12.


## Порядок шагов

#### Этап обучения модели
1. Перейдите в раздел с проектом Classifier.
1. Добавьте в проект изображения для формирования датасета, на котором будет обучаться нейронная сеть.
1. Разметьте добавленные изображения.
1. Создайте шаблон обучения для модели нейронной сети.
1. Перейдите в шаблон и создайте процесс обучения.
1. Запустите процесс обучения на целевой машине.
1. Дождитесь окончания процесса обучения, чтобы получить обученную модель.

#### Этап настройки и запуска инференса
1. Создайте шаблон процесса инференса.
1. Перейдите в шаблон и создайте процесс инференса.
1. Запустите процесс инференса на целевой машине.

#### Этап работы с RPA-проектом
1. Настройте RPA-проект, в рамках которого вы хотите распознавать типы документов классификатором.
1. Запустите выполнение RPA-проекта и получите результат классификации документов.



### Шаг 1 — Переходим в проект

Перейдите в раздел проектом Classifier.

![](<../../../.gitbook/assets1/primo-ai/classifier-1.png>)

### Шаг 2 — Добавляем изображения

***Примечание**. Ознакомьтесь с [требованиями к изображениям для обучения](https://github.com/PrimoRPA/Docs.Rus/blob/1299-%D0%BD%D0%B0%D0%BF%D0%B8%D1%81%D0%B0%D1%82%D1%8C-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82-%D0%BF%D0%BE-primoai/primo-ai/user/other/dataset-quality-requirements.md). Помните, что требуется добавить минимум 20 изображений одного типа документа.*

1. Перейдите в подраздел проекта «Данные».
2. Нажмите кнопку **Добавить изображения**.

![](<../../../.gitbook/assets1/primo-ai/classifier-2.png>)
 
3. Выберите со своего диска все изображения, которые вы хотите добавить. 
4. Нажмите **Сохранить**, чтобы изображения добавились в проект.

**Результат**. Загруженные изображения отобразятся в таблице данных проекта.

![](<../../../.gitbook/assets1/primo-ai/classifier-3.png>)

### Шаг 3 — Размечаем изображения

***Примечание**. Ознакомьтесь с [рекомендациями по разметке данных](https://github.com/PrimoRPA/Docs.Rus/blob/1299-%D0%BD%D0%B0%D0%BF%D0%B8%D1%81%D0%B0%D1%82%D1%8C-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82-%D0%BF%D0%BE-primoai/primo-ai/user/other/datalabeling-requirements.md).*

1. Перейдите в подраздел проекта «Разметка данных».
1. Нажмите кнопку **Создать схему**. Схема определяет, какие поля должна находить нейронная сеть в изображениях. 
1. Укажите произвольное название схемы и нажмите **Сохранить**.
1. Добавьте в схему поля: 
   * нажмите кнопку **Добавить поле**, назовите поле passport, сохраните изменения;
   * нажмите кнопку **Добавить поле**, назовите поле snils, сохраните изменения;
   * нажмите кнопку **Добавить поле**, назовите поле torg-12, сохраните изменения.
1. Выберите тип поля в соответствии с вашим рабочим изображением. Например, если вы работаете с Торг-12, то выберите поле torg-12.
1. Выберите в верхней панели инструмент **Add Bounding Box (b)**.
1. Выделите инструментом значимую часть документа (область с данными). 
1. В блоке «Датасет» выберите тип датасета «Обучение».
1. Нажмите **Сохранить разметку**.
1. Перейдите к следующему изображению и выберите тип поля в соответствии с типом документа на изображении. Например, если следующее изображение относится к СНИЛС, то выберите поле snils.
1. Инструментом **Add Bounding Box (b)** выделите значимую часть документа и сохраните разметку в датасете «Обучение». 
1. По аналогии с предыдущими типами документов выполните разметку для изображения паспорта. Сохраните разметку в датасете «Обучение».
1. Завершите разметку оставшихся изображений проекта. 

***Рекомендации**:
* Если изображение необходимо повернуть, используйте инструмент **Rotate image (r)  **.
* Колесиком прокрутки можно увеличивать и уменьшать масштаб изображения/рабочей области
* Примерно 10-20% изображений помещаем в тестовый датасет - зачем? Сохраняем его разметку. Изображения из тестового датасета помечаются внизу рабочей области зеленой галочкой.
* После окончания разметки изображений рекомендуется проверить качество разметки. Проверьте еще раз соответствие документов выбранным полям. Эта ошибка может негативно повлиять на качество распознавания модели классификатора.



### Шаг 4 — Создаем шаблон обучения

1. Перейдите в подраздел проекта «Обучение» на вкладку «Шаблоны обучения».
1. Нажмите кнопку **Добавить шаблон обучения**.
1. Заполните форму:
   * Укажите название шаблона.
   * Выберите тип «Классификатор».
   * В качествве шаблона модели выберите ....?
   * Выберите скрипт (?? не нужно же)
   * При необходимости укажите краткое описание модели, которое позволит идентифицировать шаблон среди других.
   * Оставшиеся параметры рекомендуется оставить без изменений. Исключение составляет параметр **Искусственно расширить датасет** — в нем выберите значение «повороты + экспозиция + шум».
1. Сохраните шаблон обучения.


### Шаг 5 — Создаем процесс обучения

1. Перейдите в подраздел проекта «Обучение» на вкладку «Шаблоны обучения».
1. Выберите для шаблона «Классификатор» действие «Процессы».
1. Нажмите кнопку **Добавить процесс обучения**.
1. В форме добавления процесса укажите:
   * Целевую машину, на которой будет проводиться обучение модели классификатора;
   * Датасет «Обучение», на котором будет тренироваться модель.
1. Сохраните настройки, чтобы процесс добавился в систему.

### Шаг 6 — Запускаем процесс обучения

1. Перейдите в подраздел проекта «Обучение» на вкладку «Шаблоны обучения».
1. Выберите для шаблона «Классификатор» действие «Процессы».
1. Для созданного процесса обучения выберите действие «Запустить».

![](<../../../.gitbook/assets1/.png>)


## Лишнее


3. Перейдите в подраздел «Схемы разметки» и создайте схему разметки для ваших изображений.
4. Добавьте в схему разметки все поля, которые могут присутствовать в том типе документа, который вы хотите распознавать. Например, для паспорта понадобится добавить поля: ФИО, дата рождения и т.д.
5. Перейдите в подраздел «Разметка данных». Выберите схему разметки, созданную в шаге 3, нажмите **Add bounding box** и с помощью специального инструмента разметьте поле на изображении. Повторите это действие для всех полей, указанных в схеме.
6. Перейдите в подраздел «Обучение > Датасеты». Добавьте датасет. Выберите ваш датасет и схему, нажмите **Перейти к добавлению**. Отобразится страница «Добавить в датасет» с таблицей размеченных изображений и кнопкой «Добавить в датасет». Выбрать все изображения и нажать на «Добавить в датасет». Датасет на этом этапе будет успешно сформирован и состоять из схемы разметки и размеченных изображений.
7. Перейдите в подраздел «Обучение > Шаблоны обучения». Добавьте шаблон обучения. При отсутствии на портале шаблона модели, необходимо его добавить через «Настройки» -> «…» -> «Шаблоны моделей».
8. Активировать меню нового шаблона процесса, нажав на символ «≡», выбрать во всплывающем меню «Процессы». Отобразится страница «Процессы обучения» с пустой таблицей и кнопкой «Добавить процессы обучения».
Нажать на «Добавить процессы обучения». Отобразится форма «Добавить Процесс Обучения» с обязательными полями «Целевая машина» и «Датасет».
Если на портале не настроена целевая машина, перейти к Требованию 2.
В списке отображаются целевые машины, с которыми не связаны другие процессы обучения для указанного типа модели (в данном случае – Торг12).
Заполнить обязательные поля, выбрав свободную целевую машину и датасет, нажать на «Сохранить».
Новый процесс обучения отобразится в таблице.
Если целевая машина занята, или агент на ней недоступен, машина не отобразится в списке.


Активировать меню нового процесса, нажав на символ «≡», выбрать во всплывающем меню «Запустить».
В этот момент запустится длительный процесс обучения на целевой машине.
Дождаться статуса «Выполняется» процесса обучения, обновляя страницу.
В этот момент запущен реальный процесс обучения, который длится несколько часов.
Итогом процесса обучения является обученная модель (архив с .pth-файлом модели, а также её метаданными – config.yaml), которая отображается на странице «Модели».
Получить обученную модель.
Есть 3 способа выполнить этот шаг:
А. Сымитировав успешное завершение обучения.
Для этого необходимо разместить в рабочей директории модели файлы:
Сама модель – model.pth.
Метаданные модели – config.yaml.
Файл-индикатор успешного завершения процесса обучения – complete.succeed.
Б. Запустив процесс обучения на целевой машине, где развернут агент, работающий с тестовой утилитой.
В этом случае процесс займет около 2 минут, а сгенерированная модель не будет рабочей.
В. Нормальное ожидание завершения процесса (несколько часов).
Активировать пункт меню «Модели».
Отобразится страница «Модели» с таблицей.
Проверить наличие вновь сформированной модели в таблице.


**Выполнение инференса**


Активировать пункт меню «Инференс».
Отобразится страница «Шаблоны процесса Inference» с пустой таблицей и кнопкой «Добавить шаблон инференс».
Нажать на «Добавить шаблон инференс».
Отобразится форма создания шаблона.
Заполнить обязательные поля:
Тип (Торг12)
Название
Модель
(выбрать обученную при выполнении испытаний Требования 3 модель, или другую заранее обученную модель)
Схема разметки
(выбрать созданную при выполнении испытаний Требования 3 схему разметки, или другую, совпадающую по структуре полей)
Новый шаблон процесса обучения отобразится в таблице.
4. Активировать меню нового шаблона процесса, нажав на символ «≡», выбрать во всплывающем меню «Процессы».
Отобразится страница «Процессы Inference» с пустой таблицей и кнопкой «Добавить Процесс Inference».
5. Нажать на «Добавить Процесс Inference».
Отобразится форма создания процесса.
6. Выбрать доступную целевую машину и нажать на «Сохранить».
В списке отображаются целевые машины, с которыми не связаны другие процессы Inference для указанного типа модели (в данном случае – Торг12).
Новый процесс отобразится в таблице.
7. Активировать меню нового процесса, нажав на символ «≡», выбрать во всплывающем меню «Запустить».
8. Дождаться статуса «Выполняется» нового процесса, обновляя страницу.
9. Отправить запрос на распознавание изображения через API-метод POST https://10.0.0.124:5022/inference/Requests  с токеном доступа, содержащим разрешения типа «Permissions.ApiInference.Request». Указать в теле запроса типа multipart/form-data изображение с документом Торг-12.
Ответом будет ключ запроса, который далее используется для получения результатов распознавания.
10. Дождаться появления результата со статусом 200, опрашивая API сервиса Inference методом GET https://10.0.0.124:5022/inference/Requests/:requestKey , где вместо :requestKey требуется указать ответ сервиса из п. 9 без кавычек.
11. Убедиться, что размеченные поля в документе распознаны.
