# Настройка NLP-проекта 

После создания проекта с типом **NLP-задачи** автоматически открывается страница настройки. Также на нее можно перейти позже, если выбрать на главной странице карточку вашего NLP-проекта.

Цель выполнения всех настроек — получить модель, готовую принимать NLP-запросы. Задачи, которые может решать модель, ограничиваются навыками, которые вы определите в ходе настройки. 

![](</primo-ai/resources/user/nlpproject/nlp_config.png>) 

На рисунке отмечены следующие элементы рабочей области:
* `1` — Область настройки LLM-модели. Это первый и обязательный шаг — каждую модель следует сконфигурировать до запуска на целевой машине или машинах. 
* `2` — Область выбора целевых машин для запуска LLM-модели. Чтобы запустить модель, сначала потребуется выбрать подходящую целевую машину, после чего произвести запуск модели на этой машине. Чтобы горизонтально масштабировать процесс, вы можете запустить модель сразу на нескольких машинах. 
* `3` — Область выбора навыков модели и их настройки. Это необязательный шаг — по умолчанию, если ни один навык не выбран, то модель сможет только генерировать тексты.
* `4` — Кнопка добавления новой конфигурации. В одном проекте может быть несколько конфигураций.
* `5` — Иконка меню для управление конфигурацией. Каждую конфигурацию можно переименовать или удалить — соответствующие команды доступны при выборе иконки.
* `6` — Вкладка **Тестирование**. Позволяет отправлять тестовые запросы, просматривать ответы модели и корректировать ее поведение при необходимости.


## Конфигурация 

Укажите основные параметры конфигурации:

1. **Выбор базовой модели** — тип базовой модели, для выбора значения разверните выпадающий список. Базовая модель — предобученная модель нейронной сети, натренированная на обширном корпусе текстовых данных, которая может понимать и генерировать текст. Базовые модели входят в поставку AI Server, а также могут быть созданы дополнительно администратором сервиса.
  
   Значения, которые доступны по умолчанию:
   * `llama3.1-8B (Vllm)` — базовая модель на сервере Vllm. Этот тип базовой модели обрабатывает запросы быстрее и точнее, но более требователен к аппаратным характеристикам целевой машины.
   * `llama3.1-8B-GGUF (Llama)` — базовая модель на сервере Llama. Позволяет запускать большую языковую модель на низкотребовательной целевой машине. 

1. **Ключ маршрутизации по умолчанию** — этот ключ используется для маршрутизации запросов к модели без выбранных навыков. Фактически такая модель будет способна только создавать текст.

Настройте расширенные параметры конфигурации:

1. **LLM-движок** — тип движка, который ассоциирован с базовой моделью. Доступные значения:
    * `Vllm` — сервер для базовой модели на Vllm.
    * `Llama` — сервер для базовой модели на Llama.
1. **Размер контекстного окна** — объем текста, который модель рассматривает перед генерацией текста. По умолчанию `4096`.
1. **Адаптер** — пропустите этот параметр, он не поддерживается для NLP-задач.
1. **Выбор устройства** — тип устройства, который используется на целевой машине с сервером LLM. Доступные значения:
    * `CPU` — значение по умолчанию. Центральный процессор, выполняющий основные операции и управляющий работой компьютера.
    * `CUDA` — архитектура CUDA позволяет использовать графический процессор (GPU) от NVIDIA для повышения производительности параллельных вычислений. CUDA представляет собой набор инструментов и библиотек для работы с графическим процессором.

Если вы выбрали `CPU`, установите:
* **Кол-во используемых CPU** — количество ядер CPU, которые будет использовать контейнер с выбранным движком для генерации ответов. 

Если вы выбрали `CUDA`, установите:
* **Кол-во используемых GPU** — количество видеокарт. Если модель не помещается в VRAM одной GPU, используйте несколько видеокарт. 
* **Загруженность видеокарты** — процент использования памяти видеокарты. 
* **Кол-во памяти от хоста** — если модель не помещается в VRAM одной GPU, оставьте часть слоев LLM на хосте.

  
## Целевые машины

Для успешного запуска модели, целевая машина должна быть включена и доступна. Агент каждой целевой машины должен быть лицензирован.

**Как запустить модель:**

1. Нажмите **Добавить машину**.
1. Выберите из выпадающего списка название машины. Добавленная машина будет ожидать запуска модели.
1. Чтобы запустить модель на машине, переведите переключатель вправо.

   ![](</primo-ai/resources/user/nlpproject/run_llm_model.png>)  
  
   Начнется автоматический процесс запуска, который состоит из последовательных стадий: запуска Logic-сервера, скачивания и распаковки модели и т.д.



1. Дождитесь, когда напротив всех стадий запуска будут проставлены галочки — это означает, что модель успешно запустилась и готова к работе.

   ![](</primo-ai/resources/user/nlpproject/nlp_statuses_model.png>) 

   Если вы обновите страницу, то вместо стадий запуска увидите только один статус — `Готова принимать запросы`.

   ![](</primo-ai/resources/user/nlpproject/model_is_ready.png>) 

Готово — теперь вы можете перейти к добавлению навыков модели.

{% hint style="warning" %}
Если в списке целевых машин нет нужного вам значения, убедитесь, что целевая машина была создана администратором на вкладке **Настройки > Целевые машины**.
{% endhint %}


**Ошибка при запуске модели**:

Если процесс запуска завершился ошибкой, то вместо статуса `Готова принимать запросы`, вы увидите индикатор ошибки. 

Ошибка может возникнуть в следующих случаях:
* Машина не включена или недоступна.
* На выбранной машине уже запущен процесс.
* 


**Как остановить модель**:

Вам может понадобиться остановить LLM-модель, чтобы выключить машину или запустить на ней модель в другом проекте. Для этого просто переведите переключатель запуска влево. Дождитесь, чтобы переключатель стал доступен для редактирования — это означает, что модель остановилась. 

**Как удалить целевую машину**:

Для удаления целевой машины из проекта нажмите иконку меню рядом с машиной и выберите **Удалить**.




## Навыки

По умолчанию, когда ни один навык для модели не указан, то она будет работать в режиме генерации текста. То есть даже в этом случае можно перейти на вкладку **Тестирование**, чтобы проверить, как модель будет создавать текст.

**Чтобы добавить другой навык**:
1. Нажмите **Добавить навык**.
1. Выберите доступный навык из списка:
   * `Классификация` — ответ на запрос из заранее определенного списка вариантов ответов. 
   * `Суммаризация` — краткое изложение текста с акцентом на определенные темы.
   * `Экстракция` — извлечение из текста информации по заданным ключам поиска.
   * `Генерация` — генерация текста по заданным параметрам.
1. Укажите ключ маршрутизации запросов для выбранного навыка. Для каждого навыка должен быть задан уникальный ключ.
1. После указания ключа автоматически отобразится **файл с контекстом** — это встроенный json-файл, который содержит ключи поиска, а также данные для ввода и вывода. Файл определяет поведение модели относительно будущих запросов. Вы можете:
   * отредактировать файл с контекстом;
   * скачать для просмотра;
   * заменить встроенный файл своим;
   * вернуть встроенный файл.

   (скрин с кнопками)

При необходимости добавьте другие навыки аналогично действиям выше.

Можно дублировать навыки, но добавлять для них другие ключи маршрутизации и файлы контекстов.

{% hint style="warning" %}
Если в списке ключей маршрутизации нет нужного вам значения, убедитесь, что все необходимые ключи были созданы администратором на вкладке **Настройки > Ключи маршрутизации**.
{% endhint %}



## Вкладка Тестирование

(Страница тестирования доступна при выполнении следующих условий: Заполнены основные параметры, Добавлена машина и на этой машине висит статус "Готова принимать запросы". Если после выполнения условий, удалить машину или остановить на ней процесс, то вкладка тестирования вновь становится недоступной)

Предназначена для тестирования указанных навыков NLP-модели. Здесь вы можете быстро проверить, как работает тот или иной навык и отладить ваши настройки при необходимости. Фактически эта вкладка показывает, что получит робот при отправке запроса на целевую машину или при использовании API-запросов. Это не способ эксплуатации модели.

Поведение в выбранном ключе маршрутизации зависит от файла с контекстом. Тестирование позволяет изменять файл с контекстом, чтобы просмотреть, как отличается поведение модели. Когда все в порядке, мы фиксируем это положение и уже дальше роботы по апи обращаются, и мы понимаем, что результат будет ожидаемым.

**Изменение файла контекста в тестировании изменит файл и для навыка на вкладке "Настройки"?** проверить

Рабочая область состоит из двух областей:
* Запрос — содержит параметры запроса.
* Ответ — ответ на запрос от NLP-модели.

### Запрос

1. **Текст для обработки\*** — входной текст для обработки NLP-моделью. На текущий момент отсутствует возможность прикреплять файл документа. Ограничение на количество символов отсутствует и определяется настройками сервера (что имеется в виду, где именно).
1. **Ключи ответа\*** — если ключей несколько, указывайте их через запятую (без ошибок):
   * для генерации - если был выбран навык Генерация, поставьте в этом поле пробел.
   * для экстракции - ключи поиска для
   * для суммаризации - ?
   * для классификации - 
1. **Ключ маршрутизации\*** — выберите ключ маршрутизации, указанный для навыка, который вы хотите протестировать.
1. **Длина ответа\*** — максимальная длина ответа модели в токенах. Для русского языка 1 слово ~ 1.5 токена. По умолчанию `256`. 


Расширенные параметры:
1. **Температура** — влияет на вариативность ответа. По умолчанию `0.1`. Максимальное значение - ?.
1. **min_p** — ограничивает что?(сэмплирование?)... чтобы не выбирать все варианты, даже маловероятные. По умолчанию `0.1`. Максимальное значение - 1.

   каждый следующий токен имеет некую вероятность появления. Она может быть 30%, 90%. И когда явная информация - модель ее найдет. А если, например, "расскажи мне стих", то будет много вероятностей. Параметр определяет, какой уровень отсечки - от самого высоко вероятного токена до самого низкого модель будет брать. Выбирает, какие варианты нужно отсеять в ответе: наиболее вероятные или менее. Если поставить 0.0., то вообще почти все вытащит.

   Если мы хотим увеличить вариативность ответов, то ставим температуру 1, а min_p 0.0.

   Если снизить галлюцинации, то температуру снижаем до 0.1, а min_p повышаем.

   По опыту самые оптимальные варианты - 0.1 для каждого параметра.
    
1. **Файл с контекстом (.json)** — возможность переопределить контекст для ключа маршрутизации.

В завершение нажмите **Отправить**, чтобы получить ответ от модели.


### Ответ

Область для получения ответа от NLP-модели. Ответ можно скопировать и обновить. 

Ошибки будут подсвечены - появится всплывашка. Добавить пример.

Ответ может быть выдан в виде текста - например, для навыка генерации. Или в виде json (структурированной информции) - например, для навыка экстракции, где будет извлекаться информация по ключам ответа.

Если по указанному ключу модель нашла несколько значений, она укажет их в значениях ключа.






### Пример тестирования навыка Генерация

---
Экстракция чем-то повторяет умный OCR, но там есть ограничение - мы должны натренировать модель, а документ должен быть заранее определенной формы. А эни док - как раз из него будет выходить текст из скана в LLM, чтобы по ключам вытаскивать структ-ю инфу.
Скан документа - в умный осr в эни док (для неструктурированной инфы), выход - сырой текст в NLP-модель.

Также работу можно настроить: модель сначала классифицирует (NLP), потом вытягивает (экстракция).
---

Например, создавать вакансию или вопросы для интервью.

### Пример тестирования навыка Экстракция

Задача - извлечь какие-то данные из текста. Большие запросы от структур, где надо вытащить, от какого клиента запрос, номер счета и т.д.

На входе - неструктурированный текст, на выходе - структурированный.

Например, ввести договор и указать ключи ответа - по которым из json вытягивается информация. Реквизиты, штрафные санкции, срок действия договора, стороны.

Для экстракции температуру и тд лучше выставлять минимальные, чтобы ограничить вариативность. 

### Пример тестирования навыка Суммаризация

в запросе - текст договора

например, в ключе прописать - о чем договор





### Пример тестирования навыка Классификация

Разбор корпоративного ящика. Есть 20 адресатов, например. 

например много писем, где нам надо понять, где спам, а где нет

или для нужд техподдержки: 
в файле контекста в инпуте надо прописать, например, "сломался принтер"
ключи - разные варианты
в выводе, например "системный админ"

в файле определяется маршрутизация по ключам - кто за что отвечает


