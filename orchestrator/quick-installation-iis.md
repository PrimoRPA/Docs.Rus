# Установка Оркестратора на веб-сервер IIS

Конфигурация:
-	Windows Server 2019
-	Internet Information Services (IIS)
-	PostgreSQL
-	RabbitMQ


## Начальная подготовка 
> *Подробнее в «Руководстве по предварительной настройке машины Оркестратора под Windows 2016 Server.docx».*

1.	Переименовываем сервер в удобно читаемое название, например, ORCHESTRATOR.
2.	Создаем папку для размещения дистрибутивов Primo.Distrib.
3.	Скачиваем и распаковываем архив с дистрибутивом оркестратора в ранее созданную папку Primo.Distrib.

## Шаг 1. Включаем IIS 
> *Подробнее в «Руководство по установке WebApi и UI на IIS под Windows 2016 Server.docx с 7-ой страницы и далее».*

Заходим диспетчер – Управление – Добавить роли и компоненты

РИСУНОК 1

Нажимаем везде Далее (все оставляем по умолчанию)
На странице Роли сервера ставим чек-бокс Веб-сервер (IIS)
На странице Службы ролей ставим чек-бокс Проверка подлинности Windows и Перенаправление HTTP

После установки запускаем IIS

РИСУНОК 2

Заходим в **Пулы приложений** и добавляем новый пул:

РИСУНОК 3

Назначаем владельцем пула Администратора (локальная УЗ Windows). 

РИСУНОК 4

РИСУНОК 5


## Шаг 2. Копируем и распаковываем архивы

Создаем папку `C:\Primo`, далее:
1.	Копируем в нее архивы: `UI.zip`, `MachineInfo.zip`, `RDP2.zip`, `States.zip`, `WebApi-IIS.zip`, `Notifications.zip`, `RobotLogs.zip`.
2.	Переименовываем `WebApi-IIS.zip` в `WebApi.zip`.
3.	Распаковываем каждый архив в эту же директорию.
4.	Удаляем все архивы (они нам далее не понадобятся).

## Шаг 3. Установка модулей и приложений
Ставим по порядку:
1.	`aspnetcore-runtime-3.1.15-win-x64.exe`.
2.	`ChromeStandaloneSetup64.exe` (устанавливаем и обновляем до последней версии).
3.	`dotnet-hosting-3.1.15-win.exe`.
4.	`PowerShell-7.1.3-win-x64.msi`.
5.	`requestRouter_amd64.msi`.
6.	`rewrite_amd64_en-US.msi`.
7.	`postgresql-13.4-1-windows.zip` (ставим согласно инструкции «Руководство по установке PostgreSQL под Windows 2016 Server.docx»).
8.	`dbeaver-ce-23.1.4-x86_64-setup.exe` (скачиваем с официального сайта).
9.	`npp.8.5.5.Installer.x64.exe`.

## Шаг 4. Настройка IIS

1. Добавляем сайт для WebApi (ПКМ по сайты – Добавить веб-сайт).

РИСУНОК 6

2. Добавляем самоподписанный сертификат. Выбираем IIS – Сертификаты сервера – Создать самозаверенный сертификат.


РИСУНОК 7

РИСУНОК 8

3. Добавляем сайт для UI и назначаем ему этот сертификат.

РИСУНОК 9

РИСУНОК 10

4. Перезагружаем сервер.
5. Запускаем IIS.
6. Выбираем сайт Primo.UI – Переопределение URL-адресов.

РИСУНОК 11

7. Далее нажимаем: «Добавить правило» - «Пустое правило».

РИСУНОК 12

Заполняем:
* Имя: Reverse Proxy to API
* Шаблон: ^api/(.*)
* URL-адрес переопределения: http://localhost:5001/api/{R:1}

8. Добавлять обратный прокси-сервер не нужно, сначала создаем правило через нажатие кнопки «Обратный прокси-сервер».

РИСУНОК 13

В этом окне нажимаем еще раз «ОК».

РИСУНОК 14

И в следующем окне нажимаем «Отмена».

РИСУНОК 15

9. Заменяем файл `web.config` в папке `C:\Primo\UI`:
   * берем файл из комплекта поставки `…\Primo Orchestrator 1.23.7.0\Distr\Windows\web.config`;
   * копируем его и вставляем с заменой в папку `C:\Primo\UI`.

РИСУНОК 16

## Шаг 5. Настройка и запуск служб










