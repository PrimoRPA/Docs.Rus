# Настройка машины Робота на Windows 2016 Server

Руководство предназначено для системных администраторов, имеющих навыки:
1.	**Обязательно – уверенный пользователь ОС Windows**:
     * Владеть Проводником Windows для перемещения по папкам и файлам.
     * Создавать и редактировать текстовые файлы.
     * Копировать файлы, копировать текст из файлов, сохранять файлы. 
2.	**Обязательно – опыт администрирования ОС Windows**:
    * Уметь запускать программы из-под Администратора.
    * Иметь опыт работы в cmd.
    * Иметь опыт работы в PowerSchell.

## Введение
Компоненты Оркестратора (выборочно) и их связи и с Роботами/Машиной робота приведены на схеме ниже:

![](<../../.gitbook/assets/Машина-Робота-W. Компоненты Орка.png>)

Полная схема приведена в разделе «Развертывание Primo RPA - Руководство администратора» **(ССЫЛКА!!)**

**Агент** – self-hosted веб-приложение. Агент выполнен как .NET Core 3.1-приложение. Агент используется для развертывания и управления Роботом на машине робота.

**Робот** – приложение, которое посредством Оркестратора развертывается на специальным образом настроенной машине (машине робота) и выполняет RPA-проект, который формируется заранее в Студии.
На одной машине может работать несколько Роботов. Все машины роботов должны быть настроены одинаково (версии ОС могут отличаться) и на каждой машине робота должен быть развернут Агент.
Машин роботов может быть много.

**Порты**, указанные на схеме выше, далее используются при настройке конфигурационных файлов компонентов Агента, машин роботов и открытия портов на файерволе файерволе Windows (в том числе аппаратном в сети организации).
Должно быть разрешено управление машиной робота по RDP. 

Для настройки машины Робота рекомендуется использовать чистую машину с Windows Server 2016 Standard x64, обязательно с последними обновлениями. И на неё должна быть скопирована папка с комплектом поставки (см. ниже раздел **Файлы из комплекта поставки**). Это может быть любая папка - для определенности пусть будет папка `C:\Install` (в скрипте `PrimoWorker.ps1` прописана именно она).

Для выполнения команд и скриптов cmd и PowerShell должны запускаться из-под Администратора.

Для настройки машины робота требуется выполнить шаги разделов 1 – 6 настоящего руководства или произвести автоматическую настройку из PowerShell-скрипта (см. «Автоматическая настройка машины Робота»).

---
## Файлы из комплекта поставки Оркестратора
Для настройки машины робота потребуются следующие файлы из комплекта поставки Оркестратора:

| Файл                         | Описание                             | Примечание                            |
| :--------------------------: | :----------------------------------: | :-----------------------------------: |
| AgentInstaller.zip           | Инсталлятор для машины робота        | Должен использоваться как основной инструмент настройки машины робота |
| Agent.zip                    | Дистрибутив Агента                   | Для настройки машины робота без инсталлятора |
| PowerShell-7.1.3-win-x64.msi | Установщик PowerShell                | См. выше     |
| ChromeStandaloneSetup64.exe  | Установщик браузера Chrome           | См. выше     |
| PrimoWorker.ps1              | PowerSchell-скрипт для настройки машины робота | См. выше |
| restore_console.bat          | Скрипт перевода RDP-сессии в консоль | См. выше      |
| RDP-Disconnector.xml         | Windows Task, запускающий restore_console.bat | См. выше |
| PasswordEncriptor.zip        | Программа шифрования паролей для конфигурационных файлов Агента | - |

Остальное ПО должно быть предустановлено в Windows.

---
## Аппаратные требования
Для машины робота требуется рабочая станция под управлением Windows Server 2016 Standard x64, которая соответствует требованиям:
* **CPU**	- 8 ядер
* **RAM**	- 8 Гб           
* **HDD**	- 250 Гб (OS + Data)

---

## Установка агента Оркестратора из инсталлятора
В разделе приведена инструкция по установка Агента и настройке машины робота из инсталлятора `AgentInstaller.zip`. Оркестратор должен быть предварительно развернут и настроен.

Инсталлятор `AgentInstaller.zip` требуется распаковать в папку `C:\Install\AgentInstaller` и запустить файл `LTools.Orchestrator.AgentInstaller.exe`:

![](<../../.gitbook/assets/Windows. Машина Робота. Распаковка инсталлятора.png>)

Откроется окно инсталлятора на вкладке **Агент**. Здесь нужно сначала заполнить поле **URL оркестратора** и нажать кнопку **Проверить**:

![](<../../.gitbook/assets/Windows. Машина Робота. Окно инсталлятора.png>)

Если URL оркестратора введен верно и Оркестратор доступен, появится окно подтверждения: 

![](<../../.gitbook/assets/Windows. Машина Робота. Окно инсталлятора-2.png>)

Далее можно выбрать тенант и ввести учетные данные Агента, с которыми он будет авторизоваться в Оркестраторе. Для тенанта по умолчанию может использоваться встроенная учетная запись **agent**. Для другого тенанта должна использоваться учетная запись этого тенанта с ролью **Agent**. 

Теперь по кнопке **Далее** нужно перейти на следующую вкладку инсталлятора **Регистрация в Оркестраторе**:

![](<../../.gitbook/assets/Windows. Машина Робота. Окно инсталлятора-3.png>)

На вкладке **Регистрация в Оркестраторе** нужно заполнить поля **IP или доменное имя машины робота**, **Наименование машины робота** и ввести данные учетной записи робота – под этой учетной записью будут запускаться роботы, не обязательно административная учетная запись. 

По кнопке **Далее** будет предложено авторизоваться в Оркестраторе для выполнения автоматической регистрации машины робота:

![](<../../.gitbook/assets/Windows. Машина Робота. Окно инсталлятора-4.png>)

После этого по кнопке **Далее** откроется вкладка **Удержание RDP** инсталлятора:

![](<../../.gitbook/assets/Windows. Машина Робота. Окно инсталлятора-5.png>)

На этой вкладке нужно ввести учетные данные пользователя с правами администратора на машине робота. От этой учетной записи далее будут выполнены все системные операции по настройке машины робота и установке нужных компонентов.

Удержание RDP здесь осуществляется только для одной RDP-сессии за счет перевода её в консоль. Если требуется удержание многих RDP-сессий, RDP-пользователи должны быть настроены отдельно после регистрации машины робота в Оркестраторе. К машине робота должны быть разрешены RDP-подключения (рисунок 30), должны быть настроены параметры подключения (рисунок 31), открыт порт для RDP .

По кнопке **Установить** запустится процесс установки и автоматической регистрации машины робота в Оркестраторе:

![](<../../.gitbook/assets/Windows. Машина Робота. Регистрация.png>)

Зарегистрированная машина робота отобразится в UI Оркестратора:

![](<../../.gitbook/assets/Windows. Машина Робота. Список машин.png>)

Далее можно через UI оркестратора добавить RDP-пользователей для поддержки многих RDP-сессий. Сами пользователи при этом должны быть уже (локальные или доменные).
Если регистрация машины робота не пройдет, машину робота можно позже зарегистрировать через UI оркестратора:

![](<../../.gitbook/assets/Windows. Машина Робота. Регистрация Ошибка.png>)

Среди запущенных служб появится служба Primo.Orchestrator.Agent:

![](<../../.gitbook/assets/Windows. Машина Робота. Primo Agent.png>)

Среди заданий Windows появится задание RDP-Disconnector:

![](<../../.gitbook/assets/Windows. Машина Робота. Задание Disconnector.png>)

На диске C:\ в корне появится файл `restore_console.bat`, который будет запускаться по заданию RDP-Disconnector:

![](<../../.gitbook/assets/Windows. Машина Робота. Файл console.bat.png>)




