# Рекомендации по обеспечению доступности

Обеспечить доступность можно за счет гео-резервирования. Используется гео-резервирование на 2-х площадках – основной и резервной – гео-кластер. Резервная площадка холодная. Или более простой вариант – за счет резервного копирования.

## Общая схема гео-резервирования

Общая схема гео-резервирования с репликацией БД и файловых хранилищ и клонированием машин роботов приведена на рисунке ниже:

![](<../../.gitbook/assets/Орк. Общая схема гео-резервирования с репликацией БД.png>)

Отсутствие стрелки от DNS (балансера) означает, что запросы на резервную площадку не идут. Синий – узел выключен физически. Оркестратор на каждой площадке обращается к только одному серверу кластера БД (master/master). Кластер БД – только репликация, без балансировки.

Особенность работы Оркестратора с лицензиями требует, чтобы сервис MachineInfo (привязка к оборудованию) был горячим одновременно на 2-х площадках в момент создания запросов на лицензии. Позже для работы достаточно одного экземпляра сервиса.

Должно быть обеспечено клонирование машин роботов между площадками и репликация файловых хранилищ Оркестратора.

Внутри прямоугольник «Оркестратор» также включает RabbitMQ. RabbitMQ для каждой площадки автономный, между узлами RabbitMQ на разных площадках репликация не предусмотрена.

## Функционирование гео-кластера
### Подготовка
Особенность работы Оркестратора с лицензиями требует, чтобы сервис MachineInfo (привязка к оборудованию) был горячим одновременно на 2-х площадках в момент создания запросов на лицензии. Обращение к нему должно быть по доменному имени. 
Оркестратор знает сразу все имена MachineInfo на всех площадках.
Позже для работы достаточно одного экземпляра сервиса.
Узел оркестратора на резервной площадке выключен, чтобы фоновые службы оркестратора не вносили ошибки в работу системы по причине несвязности узлов RabbitMQ.

###  Штатная работа основной площадки
Оркестратор работает с автономным для площадки RabbitMQ, с узлом БД этой площадки (реплицируется на узел БД на резервной площадке) и автономным узлом MachineInfo для площадки.

###  Переход на резервную площадку
В DNS (или похожем механизме) осуществляется перенаправление на машины роботов на резервной площадке и оркестратор на резервной площадке. 
Узел оркестратора включается. 
Работа в части лицензий не нарушается, так как на шаге 2.1. лицензии привязаны ко всем узлам MachineInfo, а для работы достаточно одного узла.
Работа в части БД не нарушается, так как узел БД на резервной площадке реплицирован.

###  Устранение последствий
После устранения последствий можно заменить лицензии под новый кластер узлов MachineInfo.

## Резервное копирование
Если не использовать гео-резервирование, то обеспечить доступность (при снижении SLA) также можно резервным копированием (таблица 1): 


