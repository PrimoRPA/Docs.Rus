# Развертывание 
Инструкция по развертыванию Оркестратора предназначена для системных администраторов, которые владеют навыками:

1.	**Обязательно - уверенный пользователь ОС:**
    *	Владеть инструментами ОС для навигации по папкам и файлам.
    * Создавать и редактировать текстовые файлы в стандартном для ОС редакторе.
    * Копировать файлы, копировать текст из файлов, сохранять файлы. 
    * Работать с архиватором ZIP.
    * Знать, что такое BAT-файлы, и уметь их создавать (для Windows).
2.	**Обязательно - опыт администрирования ОС:**
    * Запускать команды ОС и программы из-под Администратора/root.
    * Работать в cmd (Windows).
    * Работать в PowerShell (Windows).
    * Иметь навыки администрирования AD, DNS (Windows). В зависимости от варианта развертывания могут потребоваться навыки администрирования IIS.
    * Иметь навыки установки и администрирования служб.
    * Иметь навыки администрирования пользователей и удаленного доступа.
3.	**Обязательно - минимальный опыт администрирования БД PostgreSQL/MS SQL Server\***:
    * Устанавливать PostgreSQL/MS SQL Server на сервер и производить базовую настройку.
    * Запускать SQL-скрипты. 
4. **Желательно – опыт администрирования БД:**
    * Секционирование таблиц**. 
    * Сбор метрик.
    * Конфигурирование под высокую нагрузку.

> \* *В зависимости от СУБД Оркестратора.*\
> \*\* *Комплект поставки содержит инструкции по секционированию. В том числе для передачи журналов робота в ElasticSearch для последующего долговременного хранения и аналитики по историческим данным.*

## Общая информация

Оркестратор предназначен для развертывания в локальной сети организации. 

Локальная сеть может быть построена на основе AD - службы Active Directory. Интеграция Оркестратора с AD организации позволяет использовать технологию единого входа SSO (Single Sign-On). Настройка интеграции с AD описана в специальном разделе **ССЫЛКА**. 

Если организация состоит из обособленных подразделений/филиалов, Оркестратор может функционировать в мультитенантном варианте. В этом случае филиалу назначается тенант, который можно рассматривать как относительно независимый экземпляр Оркестратора. Настройка мультитенантности описана в разделе **ССЫЛКА**.

## Компоненты системы

На схеме ниже приведены компоненты Оркестратора (выделены замкнутой пунктирной линией) и их связи между собой, с Роботами и внешними сервисами\*: 

> \* *Распределение по машинам серверной части может отличаться в зависимости от комплекта поставки и/или принятых в организации решений по развертыванию Системы. Некоторые сервисы не показаны на рисунке.*

![](<../../.gitbook/assets/1. Компоненты Орка.png>)

Оркестратор содержит следующие компоненты (подсистемы):

1.	**Серверы БД** (PostgreSQL 13 или MS SQL SERVER 2016+):
    * Основная БД с настройками Оркестратора – Main DB (ltools\**).
    * БД с пользователями и правами – Identity DB (ltoolsidentity).
    * БД с лицензиями – License DB (ltoolslicense).
    * БД с логом событий – Logs DB с надстройкой TimescaleDB\*** (ltoolslogs).
2. **Серверы приложений**:
    * WebApi – REST веб-API -.NET Core 3.1-приложение (служба Windows или IIS).
    * RDP – приложение или служба для поддержки активных RDP-сессий.
    * MachineInfo – служба определения параметров оборудования для работы с лицензиями.
    * Front – веб-сервер для отдачи статического контента (UI администрирования в браузере, SPA) и реверс-прокси для WebApi (Nginx или IIS).
    * States – служба вычисления системных состояний.
    * Notification – служба нотификаций на email.
    * LogEventsWebhook – служба интеграции логов посредством веб-хуков\*\*\*\* .
    * RabbitMQ – брокер очередей сообщений.
3. **Agent** – .NET Core 3.1-приложение. Агент устанавливается на машине Робота как служба Windows и используется для управления Роботом и машиной Робота. Если одна машина робота делится между несколькими тенантами, для каждого тенанта устанавливается отдельный Agent на своем порту (5002, 5003, 5004, ...).
4. **Программа для шифрования паролей в конфигурационных файлах**.

В комплект поставки также включена внешняя аналитическая система Grafana, которая технически не является компонентом Оркестратора. Ее стоит рассматривать как стороннее средство для получения/визуализации аналитики по работе Оркестратора (таблица 1 №№ п/п 30 – 33, таблица 2 № п/п 28 **ССЫЛКА**).

>  \** *Здесь и далее – физическое название БД, используется в конфигурационных файлах*.\
>  \*** *В зависимости от комплекта поставки и/или принятых в организации решений по разворачиванию Системы*.\
>  \**** *Заказчик самостоятельно в соответствии со спецификацией разрабатывает интеграционный шлюз*.

## Рекомендации по развертыванию

Базы данных желательно разворачивать на отдельной машине\*. При этом Logs DB также лучше развернуть на отдельной машине от других БД, поскольку данная БД высоко нагружена. Логи желательно собирать и анализировать через Logstash в ElasticSearch (на отдельном сервере) и периодически удалять из БД.

Робот – приложение, которое разворачивается посредством Оркестратора на специальным образом настроенной машине и выполняет RPA-проект, заранее сформированный в Студии (она не входит в комплект поставки). На одной машине может работать несколько Роботов. Все машины Роботов должны быть настроены одинаково (версии ОС могут отличаться), и на каждой машине должен быть установлен и настроен Aгент. Машин Роботов может быть много.

Указанные на схеме порты (см. рисунок выше) используются при настройке конфигурационных файлов компонентов Оркестратора, машин Роботов и открытия портов на файерволе (в том числе аппаратном в сети организации).

Устанавливать Оркестратор рекомендуется на чистой машине\** с последними обновлениями. На неё должна быть скопирована папка с комплектом поставки (см. **ССЫЛКА**). Это может быть любая папка, для определенности, пусть будет **C:\Install** - полный путь зависит от ОС.

Для развертывания компонентов под OC Windows требуется PowerShell 7.1.3+. Для выполнения команд и скриптов cmd и PowerShell в ОС Windows они должны запускаться с правами администратора. В OC \*nix - под root (sudo).

После того как комплект поставки скопирован на сервер, где будет развернут Оркестратор, выполните шаги из раздела [4](**ССЫЛКА** или произведите автоматизированную установку согласно разделу [9](**ССЫЛКА**, Перепроверить верность указанного раздела.

> \* *В зависимости от комплекта поставки и/или принятых в организации решений по разворачиванию Системы.*\
> \** *Чтобы не возникло конфликтов занятых портов, файлов и т.п.*

## Дополнительно

Оркестратор может выполнять почтовую рассылку о событиях, для этого он должен быть настроен для подключения к SMTP-серверу организации.

Оркестратор может выполнять чтение писем для срабатывания триггеров заданий, для этого он должен быть настроен для подключения к POP3-серверам организации.


