# Трансляция RDP-сессии  

Параметры трансляции RDP-сессий находятся в секции `RDP` в конфиг-файле WebApi:

![](<../../../.gitbook/assets/broadcast-rdp-session.png>)

| Параметр            | Назначение           | Примечание         | 
| ------------------- | -------------------- | ------------------ |
| **RdpBaseUrl**      | URL (конечная точка Nginx) одной службы RDP2 – для случая, когда не задан AddressFilter в конфиге службы RDP2 | Начинается с внешнего URL Оркестратора. Например, на рисунке выше это: `https://192.168.0.19:44392` |
| **RdpBaseUrls**     | Сопоставление URL (конечной точки Nginx) служб RDP2 – для случая, когда задан AddressFilter в конфигах служб RDP2. Ключом является внутренний IP сервера с RDP2, значением – внешний URL, который проксируется в Nginx во внутренний IP. Внешний URL склеивается из базового внешнего URL Оркестратора и идентификатора для проксирования | В конфиге службы RDP2 должен быть прописан IP сервера с RDP2 (параметр Host). Если он не будет прописан, то определится (возможно, неправильно) из http-запроса RDP2 к Оркестратору |


## Настройка трансляции для Nginx

Параметры `RdpBaseUrl` и `RdpBaseUrls` должны соотноситься с настройкой Nginx и параметром `Host` конфиг-файла каждого экземпляра службы RDP2. Каждый экземпляр устанавливается на отдельной машине.

* Вариант 1 – Используется один экземпляр RDP2 для всех машин роботов:

  ![](<../../../.gitbook/assets/config-nginx-for-1-instance-rdp2.png>)

* Вариант 2 – Используется несколько экземпляров RDP2, множество машин роботов поделено (без пересечения!!!) между экземплярами за счет параметра `AddressFilter`:

  ![](<../../../.gitbook/assets/config-for-some-instance-rdp2.png>)

  В конфиге WebApi используется только параметр `RdpBaseUrls`. Параметр `RdpBaseUrl` не используется. В конфиге RDP2 параметр `Host` (внутренний IP сервера) желательно задать, так как определение IP машины с RDP2 из http-запроса может работать неправильно (зависит от настройки сети).

  :bangbang: ***В секции `EnabledOrigins` конфига каждого экземпляра службы RDP2 должен быть прописан внешний URL Оркестратора***:

  ![](<../../../.gitbook/assets/enabledorigins-in-config-rdp2.png>)


## Настройка трансляции для IIS

Параметры `RdpBaseUrl` и `RdpBaseUrls` должны соотноситься с настройкой Nginx и параметром `Host` конфиг-файла каждого экземпляра (на отдельной машине) службы RDP2:

* Вариант 1 – Используется один экземпляр RDP2 для всех машин роботов:

  ![](<../../../.gitbook/assets/config-nginx-for-1-instance-rdp2.png>)

  Если используется IIS, настройка осуществляется аналогично в Web.config узла Primo.UI:

  ![](<../../../.gitbook/assets/config-iis-for-1-instance-rdp2.png>)

  В конфиге WebApi используется только параметр `RdpBaseUrl`. Параметр `RdpBaseUrls` не используется. В конфиге RDP2 параметр `Host` можно не задавать.

* Вариант 2 – Используется несколько экземпляров RDP2, множество машин роботов поделено (без пересечения!!!) между экземплярами за счет параметра `AddressFilter`:

  ![](<../../../.gitbook/assets/config-for-some-instance-rdp2.png>)

  В конфиге WebApi используется только параметр `RdpBaseUrls`. Параметр `RdpBaseUrl` не используется. В конфиге RDP2 параметр `Host` (внутренний IP сервера) желательно задать, так как определение IP машины с RDP2 из http-запроса может работать неправильно (зависит от настройки сети).

  Для IIS настраивается аналогично в Web.config узла Primo.UI.

  ![](<../../../.gitbook/assets/host-parameter-in-config-rdp2.png>)

  :bangbang: ***В секции `EnabledOrigins` конфига каждого экземпляра службы RDP2 должен быть прописан внешний URL Оркестратора***:

  ![](<../../../.gitbook/assets/enabledorigins-in-config-rdp2.png>)

  -----------

## Настройка трансляции для веб-сервера Nginx

Порядок настройки зависит от количества используемых экземпляров службы RDP2. 

Возможные варианты:
* Используется один экземпляр RDP2 для всех машин роботов.
* Используется несколько экземпляров RDP2. Множество машин роботов поделено (без пересечения!) между экземплярами за счет параметра `AddressFilter`.

### Вариант 1. Один экземпляр RDP2 

![](<../../../.gitbook/assets/config-nginx-for-1-instance-rdp2.png>)

Чтобы настроить трансляцию сессии:

1. В конфиг-файле WebApi в секции **RDP** указываем значение в параметре **RdpBaseUrl**. Значение начинается с внешнего URL Оркестратора.

   Пример: `"RdpBaseUrl": "https://192.168.0.19:44392/rdpstream"`

2. В конфиг-файле RDP2 указываем значение в параметре **EnabledOrigins**.

   Пример:
   ```
   "EnabledOrigins": [
    "https://10.0.0.44:44392"
   ]
   ```
   ![](<../../../.gitbook/assets/enabledorigins-in-config-rdp2.png>)


3. Настраиваем проксирование в конфиг-файле Nginx. Добавляем:

   ```
   upstream rdpstream {
       server 10.0.0.24:5102;
   }

   location /rdpstream/ {
            proxy_pass https://rdpstream;
            proxy_set_header Host $host;
            #proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            rewrite  ^/rdpstream/(.*)  /$1 break;
        }
    ```

4. На машине, где стоит служба RDP2, должен быть открыт порт **5102**.

### Вариант 2. Несколько экземпляров RDP2

![](<../../../.gitbook/assets/config-for-some-instance-rdp2.png>)

Параметр `RdpBaseUrls` должен соотноситься с настройкой Nginx и параметром `Host` конфиг-файла каждого экземпляра службы RDP2. Каждый экземпляр устанавливается на отдельной машине.

Чтобы настроить трансляцию сессии:

1. В конфиг-файле WebApi в секции **RDP** задаем параметр **RdpBaseUrls**. Значение начинается с внешнего URL Оркестратора.

   :bangbang:***Параметр `RdpBaseUrl` здесь не используется.***

   Пример: `"RdpBaseUrls": "https://192.168.0.19:44392/rdpstream"`

2. В конфиге RDP2 параметр `Host` (внутренний IP сервера) желательно задать, так как определение IP машины с RDP2 из http-запроса может работать неправильно (зависит от настройки сети).
3. В конфиг-файле RDP2 указываем значение в параметре **EnabledOrigins**.

   Пример:
   ```
   "EnabledOrigins": [
    "https://10.0.0.44:44392"
   ]
   ```

4. На машине, где стоит служба RDP2, должен быть открыт порт **5102**.

## Настройка трансляции для веб-сервера IIS

Чтобы настроить трансляцию сессии:

1. В конфиг-файле WebApi в секции **RDP** указываем значение в параметре **RdpBaseUrl**.

   Пример: `"RdpBaseUrl": "https://192.168.0.19:44392/rdpstream"`

2. В конфиг-файле RDP2 указываем значение в параметре **EnabledOrigins**.

   Пример:

   `"EnabledOrigins": [
    "https://10.0.0.44:44392",
   ]`

3. Добавляем файл `web.config` из комплекта поставки в папку **UI**.
4. На машине, где стоит служба RDP2, должен быть открыт порт **5102**.
