# Шаблоны поиска

**Шаблон поиска** - это свойство ряда элементов Студии, которое позволяет идентифицировать компоненты приложений и получить к ним доступ. Свойство **Шаблон поиска** есть, например, у элемента [Клик мышью](https://docs.primo-rpa.ru/primo-rpa/g_elements/osnovnye-elementy/els_uiinteraction/el_click) - с его помощью можно определить кнопку приложения, по которой нужно кликнуть.

Шаблон представляет собой JSON-файл, который содержит заданный набор свойств для идентификации компонента и другие вспомогательные параметры. Его можно сформировать вручную или автоматически. Для автоматического формирования шаблона используется кнопка **Выбрать компонент** ![](<../../../.gitbook/assets/image (794).png>) - она вызывает захват элемента управления в зависимости от категории приложения. 

Поддерживаются следующие категории приложений:

* **Браузер**
* **Рабочий стол**
* **SAP** 

Редактировать шаблон можно двумя способами:
* **В формате правки JSON-файла.** Для открытия файла нажмите в свойстве **Шаблон поиска** значок многоточия. Пример: ![](<../../../.gitbook/assets/Шаблон поиска. Многоточие (2).png>). 
* **Через окно редактора шаблона**. Для открытия графического окна нажмите кнопку ![](<../../../.gitbook/assets/image (516) (1) (2) (1) (1) (2) (2).png>). Вид окна редактора зависит от типа элемента.

В ситуации, когда категория приложений неизвестна, редактор шаблона поиска будет выглядеть следующим образом:

![](<../../../.gitbook/assets/image (959).png>)

## Как осуществляется поиск

Рассмотрим, как происходит процесс поиска на примере работы с приложением **Калькулятор** (категория **Рабочий стол**).

Как Primo RPA идентифицирует компонент приложения? Для этой цели используются селекторы (свойства компонента) - они идентифицируют элемент приложения (кнопки, текстовые поля, таблицы), а также разбивают все компоненты рабочего стола по тегам и классам, и предоставляют информацию о специфике и назначении компонента. 

Откроем приложение **Калькулятор** в Windows. Далее создадим в Студии новый проект и добавим в него элементы:
1. **Присоединиться к приложению**. Укажем в свойстве **Заголовок** название приложения - Калькулятор.
2. Поместим в контейнер **Присоединиться к приложению** элемент **Клик мышью**. 
 
На панели элемента **Клик мышью** нажмем кнопку **Выбрать компонент** - для его автоматического добавления в шаблон. Обратите внимание, что окно с приложением **Калькулятор** должно быть развернуто (можно добавить в конейнер дополнительный элемент **Открыть окно** или вроде того). 

При наведении на компонент, он будет подсвечиваться, а в левом углу появится увеличенное изображение выбранного компонента. При выборе элемента, скажем, кнопки 5, появится всплывающее окно с набором свойств выбранного компонента. В этом окне можно выбрать параметры для поиска (селекторы). 

Выбираем параметр **AutomationID** и нажимаем **ОК** - селектор создан. Он сохранится в JSON-файл шаблона поиска. Шаблон просмотреть через встроенный редактор или многоточие. 

Робот берет заданные свойства, например, AutomationID, и пробегает по дереву компонентов, подбирая позицию, которая имеет нужное значение в параметре AutomationID. Если параметр отсутствует, то можно выбрать свойство Text или Name. Чаще всего их значения в рамках одного компонента совпадают.

Есть ряд свойств, за которые зацепиться нельзя. Например, BoundingRectangle - параметр, который содержит координаты объекта. Если его использовать, то можно получить некорректный результат, потому что координаты кнопки могут меняться при перезапуске приложения. 

Опция **Полное дерево контроллов** - это многоуровневый селектор, который имеет ряд трудностей при использовании. Он работает намного медленнее, чем точечный выбор параметров. 


## Интерфейс редактора шаблона

![](<../../../.gitbook/assets/Шаблон поиска. Интерфейс.png>)

Интерфейс редактора шаблона для категорий **Браузер** и **Рабочий стол** имеет ряд общих опций:

> *Интерфейс редактора шаблона для категории **SAP** выглядит иначе и представлен ниже, в соответствующем разделе.*

1. **Тип приложения** - иконка выбора между вариантами среды, для которой создается шаблон.
2. **Подтип приложения** - выбор подтипа приложения/браузера.
3. **Процесс** - название процесса в Windows. Используется только для приложений рабочего стола. Можно указать либо процесс, либо название. Процесс - это контейнер с набором ресурсов для выполнения программы. То есть запускаем мы программу, для неё выделяется часть ресурсов компьютера и эта программа работает с этими ресурсами.
4. **Заголовок** - параметр для поиска. Например, в него можно ввести название приложения.
5. **Выбрать компонент** - позволяет автоматически выбрать элемент управления и добавить его в шаблон.
6. **Отобразить компонент** - выделяет элемент управления, который был задан в шаблоне.
7. **Инспектор UI** - инструмент для исследования интерфейсов приложений. Показывает детальную информацию о нужном приложении и обо всех его компонентах (см. рисунок ниже). Позволяет перенести выбранный элемент в шаблон.
8.  ![](<../../../.gitbook/assets/12 (2) (3) (1) (1) (1).png>) - кнопка для ручного добавления элемента управления в шаблон.
9. ![](<../../../.gitbook/assets/13 (1) (1) (2) (1) (1) (1).png>) - кнопка удаления шаблона. Удалить его можно также клавишей Del.

## Инспектор UI

Кнопка **Инспектор UI** ![](<../../../.gitbook/assets/6 (2).png>) отображает модуль исследования интерфейса. Пример:

![](../../../.gitbook/assets/17.png)

При помощи кнопок ![](<../../../.gitbook/assets/18 (1) (2) (1) (1) (2) (2).png>) и ![](<../../../.gitbook/assets/19 (1) (2) (1) (1) (2).png>) происходит перенос выбранных элементов в шаблон.

Он поддерживает переключение режимов Win32/Java/MSAA. Работа с Java возможна после установки Java Access Bridge, но даже с ним можно исследовать не все приложения этого типа. В этом модуле можно исследовать структуру приложения.


## Браузер ![](<../../../.gitbook/assets/Категория. Браузер.png>)

Шаблон поиска для категории приложений **Браузер** выглядит следующим образом:

![](<../../../.gitbook/assets/image (562).png>)

Для добавления элемента управления вручную:
1. Нажмите кнопку ![](<../../../.gitbook/assets/12 (2) (3) (1) (1) (1).png>), после чего выделите новую строку и введите данные в поля **Тэг, Текст, Индекс** (начинается с единицы) и **Искать во фреймах** (поиск внутри элементов iframe). 
2. Для уточнения поиска можно ввести имена и значения атрибутов тэга в таблицу (ключ, значение). Если указать несколько строк, поиск элемента в браузере будет вестись вглубь от самого верхнего шаблона.

Для автоматического добавления элемента нажмите кнопку **Выбрать компонент** ![](<../../../.gitbook/assets/14 (1) (2) (1) (1) (2) (2).png>) и в нужном окне браузера кликните искомый элемент. Также можно использовать кнопку быстрого добавления на самом элементе.

## Рабочий стол ![](<../../../.gitbook/assets/Категория. Десктоп.png>)

Шаблон поиска элементов **Рабочий стол** выглядит следующим образом:

![](<../../../.gitbook/assets/image (942).png>)

Перед добавлением элемента убедитесь, что выбран правильный подтип приложения:

![](<../../../.gitbook/assets/Шаблон. Подтип приложения.png>)

Существуют следующие подтипы:

* **UIAUTOMATION** - подходит для приложений Рабочего стола, которые работают по правилам Win32. В данном режиме хорошо работает параметр **Быстрый поиск**.
* **UIAUTOMATION_UIA** - рекомендуется использовать в случае, если в режиме UIAUTOMATION не удается получить доступ к нужному элементу управления. Фактически более старая технология.
* **MSAA** - библиотека Microsoft Active Accessibility. Так же, как и UIAUTOMATION, предоставляет информацию об элементах пользовательского интерфейса в приложениях Windows, но имеет больше ограничений, т.к. это устаревшая технология. Обращение к MSAA будет полезным в ограниченном количество случаев: например, когда при поиске текстовых элементов необходимо использовать свойство идентификации **Role**. 
* **JAVA** и **JAVA_EXT** - режимы предназначены для Java-приложений.
* **RDP** - используется для работы с теми приложениями, где нельзя получить доступ к элементам управления другим способом. В данном режиме логин нужно устанавливать на клиент и на RDP-сервер. После чего они могут взаимодействовать друг с другом по ASP. 

**ВНИМАНИЕ!!! При работе с Java, разрядность Студии и Робота должны совпадать с разрядностью Java.**

Для добавления элемента шаблона вручную:
1. Нажмите кнопку ![](<../../../.gitbook/assets/12 (2) (3) (1) (1) (2) (2).png>), далее выделите новую строку и введите данные в поля **AutomationID, Name, ClassName, ControlType, LocalizedControlType** и **Индекс** (начинается с единицы). 
2. Для уточнения поиска можно ввести имена и значения атрибутов искомого компонента в таблицу (ключ, значение). Если указать несколько строк, поиск элемента в роботизируемом приложении будет вестись вглубь от самого верхнего шаблона. Для укороченного маршрута используется параметр **Быстрый поиск** (включен по умолчанию).

> AutomationID - одно из самых важных свойств для RPA. Оно не изменяется при каждом запуске и однозначно идентифицирует компонент вне зависимости от экземпляра процесса, в котором он задействован.

 

Функция **Быстрый поиск** - включена по умолчанию. Когда отключена, Студия просматривает все дерево компонентов от и до. Когда включена - используется встроенный поиск Microsoft, т.е. укороченный маршрут. Этот алгоритм учитывает правила построения дерева, из-за чего часто возникают ситуации, когда нужный компонент существует, но найти его не получается. АКТУАЛЬНО ЛИ - Поэтому практика применения такова: сначала ищем в режиме без быстрого поиска, затем в быстром поиске. Если быстрый поиск применим, оставляем его. Если нет - оставляем полный поиск.

Для автоматического добавления элемента используйте опцию **Выбрать компонент** ![](<../../../.gitbook/assets/14 (1) (2) (1) (1) (2).png>) и кликните искомый элемент в окне нужного приложения.

В случае, если необходим обход всего дерева контроллов, воспользуйтесь кнопкой **Автопоиск** с установленным чекбоксом **Все дерево**:

![](<../../../.gitbook/assets/image (453).png>)

## SAP ![](<../../../.gitbook/assets/Категория. SAP.png>)

При работе с SAP рекомендуется использовать специализированные компоненты.

Шаблон поиска для категории **SAP** выглядит следующим образом:

![](<../../../.gitbook/assets/image (551).png>)

Если происходит работа с WebView SAP, шаблон поиска будет иметь следующий вид:

![](<../../../.gitbook/assets/image (465).png>)

Область Browser представляет собой шаблон поиска для браузера.

В шаблонах поиска SAP допускается использование символа \*.

## Контейнеры

По-прежнему рекомендуется использовать элементы совместно с контейнерами. Для этого в редакторе шаблона поиска нужно выбрать **Контейнер**:

![](<../../../.gitbook/assets/image (509) (1) (2) (1) (1) (2).png>)

## Дополнительно

В шаблонах поиска можно использовать символ \* и имена переменных в формате {переменная}. Если вы прописываете переменную, то Робот во время работы будет менять переменную на нужное значение. Вызов переменной может быть прописан прямо в JSON. Шаблоны могут быть многоуровневыми, комплексными. Такой шаблон более гибкий в условиях поиска конкретного объекта. 

Взаимодействие с пользовательским интерфейсом программ
 

Символ \* 

