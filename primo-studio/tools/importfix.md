# PrimoImportFix

## Обзор
Программа **PrimoImportFix** позволяет корректировать \*.ltw файлы Primo Studio, сформированные после процедуры импорта из проекта UiPath. 

Корректировка представляет собой замену участков кода с помощью последовательного применения регулярных выражений (RegExp) к содержимому файлов \*.ltw. Целью корректировки является исправление типовых ошибок импорта, связанных с различиями синтаксиса кода UiPath Studio и Primo Studio. Такие ошибки могут встречаться в импортируемом проекте многократно, поэтому использование приложения экономит много времени при переносе проекта с UiPath на платформу Primo. Исправления могут быть реализованы по-разному: это может быть замена синтаксиса скриптов внутри модулей либо добавление/корректировка самих модулей и их свойств. Достаточно открыть программу, выбрать все или несколько файлов  \*.ltw в папке Primo проекта и нажать на кнопку **Старт**. В результате более 70% ошибок будут исправлены автоматически.

Дополнительные возможности программы, которые открываются по кнопке **Настройки**, позволяют изменять существующий набор операций исправления кода (набор регулярных выражений), добавлять новые, с возможностью сохранения и восстановления индивидуальных настроек. Файлы, перед исправлением программой **PrimoImportFix**, сохраняются как резервные копии в подпапке **Backup** проекта, с отметкой времени изменения в имени файла. Они легко могут быть восстановлены в случае каких-либо некорректных правил редактирования. Таким образом, пользователь, обладая знаниями синтаксиса RegExp, может экспериментировать с настройками, максимально оптимизируя автоматическое исправление ошибок и не опасаясь повредить проект. 

## Быстрый старт

После запуска программы PrimoImportFix.exe появляется диалог с предложением выбрать один или несколько \*.ltw файлов проекта для преобразования. 

Выбрать одновременно несколько файлов можно, используя кнопку мышки и клавишу `Ctrl`:

![](<../../.gitbook/assets/importfix_start1.png>)

Откроется основное окно программы. В разделе файлов проекта будут отмечены выбранные файлы. Выбор можно скорректировать путем установки или снятия флажков напротив имен файлов:

![](<../../.gitbook/assets/importfix_start2.png>)

В дальнейшем папку с проектом можно выбрать повторно, изменяя путь на нужный в верхнем левом поле редактирования, или вызвав диалог открытия файлов кнопкой с изображением папки:

![](<../../.gitbook/assets/importfix_start3.png>)

Нажатие на кнопку **Старт** запустит преобразование выбранных слева файлов. 

Если в ходе обработки какой-то из файлов не подвергнется изменению (не будет найдено ошибок, удовлетворяющих списку правил исправления), то программа выдаст сообщение вида: `Исправлений для файла *** не найдено`.

![](<../../.gitbook/assets/importfix_start.gif>)

После появления сообщения об успешном завершении операции программу можно закрыть, перейдя в Primo Studio для дальнейшей работы.

![](<../../.gitbook/assets/importfix_start4.png>)

## Описание интерфейса программы

![](<../../.gitbook/assets/importfix_interface3.png>)

1. Папка с Primo Studio проектом. Путь к проекту можно изменить вручную или с помощью кнопки диалога, справа от поля ввода. Программа при этом контролирует наличие \*.ltw файлов в выбранной папке.
2. Раздел выбора файлов для конвертации. После выбора папки с проектом в этом поле отобразятся все \*.ltw файлы из данной папки. Выбрать файлы для конвертации можно с помощью кнопки мыши, двойным кликом или клавишей пробела.
3. Раздел, соответствующий подпапке **Backup** папки с проектом. Тут отображаются резервные копии \*.ltw файлов, которые создаются после нажатия на кнопку **Старт** до процедуры изменения. Имена файлов соответствуют начальному файлу, символу минус `-` и последующей метки даты-времени. Если до этого преобразование файла не проводилось, то метка времени будет пустой, что соответствует начальному состоянию файла (импортированного средствами программы Primo Studio).
4. Кнопка запуска преобразования выбранных \*.ltw файлов. Преобразуются не выделенные файлы, а выбранные галочкой. После успешного преобразования у этих файлов галочка снимается. В конце преобразования всех выбранных файлов появится информационное сообщение об успешном завершении операции.
5. Кнопка восстановления файлов. Она становится активной только после того, как в разделе резервных копий файлов будет выбран хоть один файл. Восстанавливаются не выделенные файлы, а выбранные галочкой. Например, если выделен файл `Main-220603105118.ltw`, то после нажатия кнопки **Восстановить** соответствующий файл, из подпапки .\Backup, скопируется с перезаписью в файл `Main.ltw`. **При этом, желательно, чтобы соответствующий файл `Main.ltw` не был открыт в Primo Studio!**
6. Кнопка **Настройки** открывает или закрывает нижнюю панель настроек, содержащую список процессов, которые последовательно выполняются при нажатии на кнопку **Старт**.
7. Выбор оформления программы (скина) из раскрывающегося списка. Выбранное оформление сохраняется при закрытии и восстанавливается при открытии программы. Настройки программы хранятся в профиле пользователя Windows – папке `%APPDATA%\PrimoImport\`.
8. Галочка **Режим разработчика** включает или отключает расширенный режим настроек.
9. Таблица последовательности производимых изменений, которые происходят при нажатии на кнопку **Старт**. Галочкой **Активно** можно отключать или включать выбранное действие. Вид таблицы меняется в зависимости от состояния галки **Режим разработчика**.
10. Кнопка диалога загрузки настроек таблицы изменений из файла настроек в бинарном формате \*.fds или текстовом \*.xml.
11. Кнопка диалога сохранения текущей таблицы изменений в бинарный формат \*.fds или текстовый \*.xml.
12. Кнопка восстановления таблицы изменений по умолчанию, которая хранится внутри программы и меняется с каждой версией программы.

## Восстановление исходных файлов из резервных копий
Перед каждым изменением файла происходит его резервное копирование. Файл копируется в подпапку Backup, расположенную рядом с файлом \*.ltw. При этом к имени файла добавляется постфикс, начинающийся с символа минус и с последующей меткой даты и времени, вида `-YYMMDDhhmmss`. 

Например, при обработке файла `D:\Projects\FiscalizationPays_Primo\Main.ltw` перед его преобразованием он скопируется с именем `D:\Projects\FiscalizationPays_Primo\Backup\Main-220601170530.ltw`, если запуск был произведен 01.06.2022 в 17:05:30. Если соответствующих резервных копий не было найдено в папке Backup, то файл `Main.ltw` будет скопирован с именем `Main-.ltw` (без отметки времени). Такие файлы будут соответствовать исходным файлам, получившимся после встроенного в Primo модуля импорта. При восстановлении файла происходит его обратное преобразование с перезаписью файла `Main.ltw` (из данного примера). 

Чтобы восстановить файл, необходимо отметить нужные файлы резервных копий галочкой и нажать на кнопку **Восстановить**:

![](<../../.gitbook/assets/importfix_backup1.png>)

Удалить резервные копии из списка и, соответственно, из папки Backup можно при помощи команды контекстного меню **Удалить резервный файл**:

![](<../../.gitbook/assets/importfix_backup2.png>)

## Настройки программы 
При нажатии на кнопку **Настройки** появляется панель настроек программы, которая включает  таблицу с последовательностью настроек исправлений (настроек поиска и замены текстовых фрагментов \*.ltw файлов) а также кнопки сохранения\восстановления таблицы настроек (см. раздел *Описание интерфейса программы*). Если пользователь знаком с синтаксисом регулярных выражений (RegExp), то он может включить режим разработчика соответствующей галочкой в нижнем левом углу, чтобы увидеть скрытые столбцы таблицы, соответствующие RegExp-выражению поиска (столбец  **Выражение**) и столбец с шаблоном замены (столбец **Замена**).

![](<../../.gitbook/assets/importfix_settings1.png>)

С помощью регулярных выражений можно не только исправить ошибки, связанные с разницей в синтаксисе команд Visual Basic и C#, но и изменять свойства модулей Primo. Например, в шаге 17 производится установка параметра **DBConnect** во все модули работы с базой данных, такие как [**Вставка данных**](https://docs.primo-rpa.ru/primo-rpa/g_elements/el_basic/els_db/el_db_insertdata) или [**Выполнить запрос**](https://docs.primo-rpa.ru/primo-rpa/g_elements/el_basic/els_db/el_db_exec). К сожалению, после штатного импорта UiPath проекта этот параметр теряется. Если у Вас присоединение к базе данных имеет другое имя, то можно его переименовать в DBConnect, или совсем отказаться от выполнения подстановки **DBConnect**, сняв галочку активности с операции №17 перед нажатием на кнопку **Старт**. Также можно изменить в поле **Замена** DBConnect на нужное имя подключения, соответствующее проекту, например на Connect1, тогда поле **Замена** изменится следующим образом:

Старое значение: `$1$2<Value xsi:type="xsd:string">DBConnect</Value>$2$3`\
Новое значение: `$1$2<Value xsi:type="xsd:string">Connect1</Value>$2$3`

В программе есть возможность выполнять выборочно отдельные правила замены на выбранных файлах. Это можно сделать, выбрав пункт контекстного меню **Выполнить текущую операцию с выбранным файлом**, вызванный на любой строке регулярного выражения. При этом не нужно нажимать на кнопку **Старт**. Выделенная команда замены выполняется независимо от положения флажка активности. Резервная копия файла будет создана так же, как если бы Вы нажали на кнопку **Старт**. 

![](<../../.gitbook/assets/importfix_settings2.png>)

Добавляя или изменяя строки регулярных выражений, можно значительно расширить автоматизацию исправления ошибок импорта, анализируя разницу между исходными файлами, полученными после Primo импорта, и файлами, исправленными вручную. Такое сравнение можно делать, например, используя плагин **Compare** программы [Notepad++](https://notepad-plus-plus.org/downloads/). Таким же образом можно тестировать новые регулярные выражения, проверяя корректность преобразования.

![](<../../.gitbook/assets/importfix_settings3.png>)

![](<../../.gitbook/assets/importfix_settings4.png>)

Справочник по регулярным выражениям можно найти [здесь](https://docs.microsoft.com/ru-ru/dotnet/standard/base-types/regular-expression-language-quick-reference) или, например, [здесь](https://regex.sorokin.engineer/ru/latest/regular_expressions.html).


## Внешний вид интерфейса, выбор скинов

Программа PrimoImportFix позволяет менять внешний вид на любой вкус пользователя с помощью выбора скинов. Настройки выбора сохраняются в профиле пользователя:

![](<../../.gitbook/assets/importfix_skin.gif>)



