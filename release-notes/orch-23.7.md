# Обновления в версии Оркестратора 23.7

Примечания к выпуску Оркестратора 23.7 описывают изменения для версии приложения, выпущенной в июле 2023 года.

 минута. 

### Новые функции
1. Много оптимизаций, связанных с кластерным вариантом разворачивания Оркестратора (вебапи в кластере). Например: 
2628 - [локальный ажур] Оптимизация сбора состояния (опроса) машин роботов в кластерном варианте. Внутри пояснений нет.

В общем, был проделан ряд оптимизаций по кластеру - это опросы машин, события RDP, события роботов. 
При разворачивании Орка в кластере нужно, чтобы они друг друга не перебивали (кто - "они"?), поэтому для них было сделано разделение id-ов из базы. И на старте нового узла они обмениваются между собой инфой, согласовывают, кто за какими роботами, машинами и за какими учетками RDP будет следить. 
Т.е. в Орке веб-апи реализовано по этому списку несколько фоновых служб, которые следят за доступностью машин роботов, за состоянием роботов, и в фоне это отрабатывают. Отпускают повисшие РДП-сессии в том числе. Чтобы они друг друга не дублировали, если поднялся кластер, у нас несколько Орков, каждому просто назначается на старте свой диапазон id-ов по каждой службе. Вот такая оптимизация (это заявки 2628, 2641, 2643).
- (2641) Оптимизация опроса роботов на разные таймауты/события в кластерном варианте
- (2643) Оптимизация освобождения RDP-сессий и разлогинивания пользователей в кластере

Также была сделана оптимизация работы с РПА-проектами: у нас теперь исходники проектов хранятся в базе, а раньше хранились на диске. Суть: службу, которая следила и проверяла файлики на диске, ее заглушили. перестала использоваться проверка наличия файлов на диске.
"Оптимизация работы с RPA-проектами - не используется проверка наличия файлов архива на диске, так как архивы хранятся в БД".

2. какая задача? - Устранение ошибки при возврате "Попытка изменить статус элемента другим роботом". (это фикс ВТБ (это подверсия орка? 23.6.1), который по чтению элементов в очереди). Там при чтении в очереди др роботом, не из студии, возвращался forbid, вместо конфликта. Максим нашел, поправил.

3. 

- (2670) Просмотр активной сессии RDP


### Исправленные ошибки
1. 2532 - не все пункты настроек доступны админу при AD-авторизации. Раньше при авторизации с доменной учеткой в UI некоторые пункты не отображались либо были недоступны для редактирования.
2. (2064) Раббит не создает каналы в WebApi при старте. Иногда вебапи стартовал нормально, иногда нет. Оказалось, что в раббите есть каналы (иксченжи) и очереди обычные и автоудаляемые. И вот на автоудаляемых очередях и иксченжах вот эта штука происходила. У нас одни и те же очереди и иксченжи могут создаваться как Орком, так и сервис.робот.логс. Если сервис.робот.логс запускается раньше орка, то все создается нормально. А если вебапи стартовал раньше сервис.робот.логс, то возникал баг, и он начинал сыпать исключениями, и порой раббит даже все коннекшены обрывал. Теперь исправлено, разницы между стартами нет.
3. (2019) Шифровать ключевую фразу для сертификата p12 к раббиту. Был тикет, сделать, чтобы коннекшн с раббитом был с сичпо-м ссл. Для этого исп-ся сертификат P12 и для него исп-ся ключевая фраза. Кл фраза была сделана по тикету без шифрования, поэтому мог кто-нибудь посмотреть ее и приконектиться. У нас 5 сервисов, которые работают с раббитом, и на всех сервисах надо было зашифровать кл фразу. Все сделано. (должны быть внесены изменения в доку по SSL).
4. (2653/846) Не происходит снятие зависших блокировок триггеров, если временные зоны у орка и БД разные. На снятие блокировок есть сервис специальный, который обходит и проверяет. Возникла проблема: если вдруг Орк и БД находятся в разных временных зонах, то эти проверки не срабатывают. Ибо по умолчанию у нас подразумевается, что они в одной зоне. И тут проверка не срабатывала. Поправили, перешли на UTC, проблема исчезла. (с# при преобразовании в код на sql преобразует в код на дату машине - поэтому если у орка дата одна, а на машине другая, ранняя, то роботы начинают работать, устанавливать блокировки, то сервис должен снимать блокировки через таймаут. а тут время разное, снять блокировку невозможно, они накапливались. а потом когда останавливались задания, блокировки снимались и через час-два задания могли самопроизвольно выполняться. баг касался только постгреса)




- (830/837) Возможность организации технической паузы для машины роботов. Исправление бага с постоянно растущим ID РДП-сессии
- (907) Фиксация периодов "простоя" машины роботов
- (1868) Возможность указать для версии проекта значение "Закрыть RDP-сессию" отличное от значения родительской
