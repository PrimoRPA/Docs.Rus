# Развертывание Astra Linux на виртуальной машине для Primo Studio Linux

## Развертывание проекта

### Клонирование проекта
* Перед клонированием проекта получите права доступа на соответствующий репозиторий проекта. Репозиторий проекта находится [здесь](https://azure-dos.s1.primo1.orch/PrimoCollection/_git/Studio%20Linux).
* После получения доступа к репозиторию, настройте OpenSSH-ключи. Информацию о создании OpenSSH-ключей можно найти [здесь](https://learn.microsoft.com/en-us/azure/devops/repos/git/use-ssh-keys-to-authenticate?view=azure-devops).  
**Строго** следуйте инструкции, не меняйте оригинальных названий и расположений файлов (обычно id_rsa файлы в .ssh подпапке папки пользователя), так как Azure *не поддерживает* формат PuTTY SSH, и SSH-подключение на некоторых git-клиентах может быть чувствительным к названию и расположению соответствующих файлов ключа.
* Скачайте проект по SSH в удобное место.

### Сборка проекта под Microsoft Visual Studio 2022 (MS VS 2022)
* Для работы с проектом в установщике MS VS 2022 доустановите компонент **WSL**, если он не установлен. Информацию о **WSL** можно найти [здесь](https://learn.microsoft.com/ru-ru/windows/wsl/about). Дополнительно про использование отладки с **WSL** можно узнать [здесь](https://learn.microsoft.com/ru-ru/visualstudio/debugger/debug-dotnet-core-in-wsl-2?view=vs-2022).
* Для успешной компиляции проекта установите соответствующую версию *DevExpress* (на момент написания руководства - >= 22.2.6). Нужную версию *DevExpress* можно взять [здесь](https://disk.yandex.ru/d/UV-RRlrnPWPs2w).
В данном хранилище на Я.Диске скачайте файл *DevExpressUniversalTrialCompleteSetup-20230427.exe* - это установочный файл *DevExpress* **v22.2.6**. При установке для исправления данного файла используйте файл из архива *DevExpress.Universal.20.1.3.zip* того же Я.Диск хранилища.
* В nuget-настройках добавьте ссылку на локальный nuget-репозиторий. Локальный nuget-репозиторий имеет адрес [http://10.0.0.56:8080/v3/index.json](http://10.0.0.56:8080/v3/index.json).
* Соберите проект в *Debug*.
* Если все собралось без ошибок, запустите *LTools.Studio*.
* Если Студия успешно запустилась, сборка проекта прошла успешно.

### Конфигурация ОС Astra Linux для проверки/тестирования собранного приложения

* Установите *Oracle VirtualBox* (в текущей инструкции используется версия v7.0.14). Установочный файл находится [здесь](https://www.virtualbox.org/wiki/Downloads).
* Общую информацию о разворачивании *Astra Linux* под *Oracle VirtualBox* можно найти [здесь](https://wiki.astralinux.ru/pages/viewpage.action?pageId=1212623).
* Образ *Astra Linux* для установки (v1.7.2-11.08.2022/15.28) находится [здесь](https://disk.yandex.ru/d/HhYBPWzOJ5ZKAg).
* Рекомендуемые аппаратные настройки виртуальной машины - 4 ГБ памяти и 4 ядра процессора.
* Установите *Astra Linux* с настройками по умолчанию.
* После установки *Astra Linux* установите гостевые дополнения для *Oracle VirtualBox*. Дополнения гостевой ОС (гостевые дополнения) позволяют включить режим расширенного взаимодействия (буфер обмена, настройки разрешения экрана и режим drag & drop) между основной и гостевой ОС в *Oracle VirtualBox*.  
**!!Важно!!** версия гостевых дополнений, установленных для соответствующей виртуальной машины в *Oracle VirtualBox* должна **строго** соответствовать версии *Oracle VirtualBox*.
  - Для установки можно воспользоваться образом гостевых дополнений для соответствующей версии *Oracle VirtualBox*. Например, для версии *Oracle VirtualBox* v7.0.14 образ гостевых дополнений (файл VBoxGuestAdditions\_X.X.XX.iso, где X.X.XX - соответствующая версия *Oracle VirtualBox*) находится [здесь](http://download.virtualbox.org/virtualbox/7.0.14).  
**!!Важно!!** Образ гостевых дополнений также **уже** идет в комплекте с версией *Oracle VirtualBox* (как минимум, с версии v6), можно использовать его (смонтировать) через соответствующий подпункт меню `Устройства` в окне виртуальной машины.
* Установите гостевые дополнения для *Astra Linux*. Инструкцию по установке гостевых дополнений можно взять из раздела "Установка гостевых дополнений Oracle VirtualBox", изложенного [здесь](https://wiki.astralinux.ru/pages/viewpage.action?pageId=1212623). Данная инструкция **не является полной/исчерпывающей** и требует действий/дополнений, изложенных ниже.
  - Дополнение 1: чтобы установить необходимые пакеты (команда `sudo apt install gcc make perl linux-headers-'uname -r'` инструкции), необходимо подключить внешние репозитории. По умолчанию они отключены. Чтобы использовать внешние репозитории, поочередно раскомментируйте в файле `/etc/apt/sources.list` соответствующие ссылки на внешние репозитории с последующим выполнением команды `sudo apt update`;
  - Дополнение 2: после установки гостевых дополнений включите в подпунктах меню `Устройства` соответствующей виртуальной машины ОС буфер обмена и режим drag and drop.
  - Дополнение 3: для пользователя гостевой ОС выполните команду `sudo usermod -aG vboxsf <логин_вашего_пользователя>`.
* После установки гостевых дополнений рекомендуется также выполнить их *обновление* через соответствующий подпункт меню `Устройства` соответствующей виртуальной машины ОС.
* Так как итоговая работоспособность режима drag & drop не гарантируется, рекомендуется также настроить взаимодействие внешней и гостевой ОС через общие папки. Настроить общие папки у внешней и гостевой ОС можно через подпункт `Настройки` меню `Машина` на вкладке `Общие папки`.

### Публикация проекта в конфигурации под ОС Astra Linux и его финальный запуск

* Опубликуйте проекты в указанном порядке:
  - *LTools.WebBrowser.Native*;
  - *LTools.Robot.Runner*;
  - *LTools.Robot*;
  - *LTools.Studio*;
* Для публикации вышеуказанных проектов используйте  соответствующие publish-профилями *Linux-x64.pubxml* проектов.
* Результат публикации *LTools.Studio* перенесите на целевую гостевую ОС *Astra Linux*.
* Откройте терминал в папке с проектом.
* Убедитесь, что есть права на запуск приложения командой `ls -l ./Primo.Studio`.
* Если прав на запуск приложения нет, выставите их через команду `sudo chmod -R 777 .`.
* Запустите приложение командой `./Primo.Studio`.
* Если Студия успешно запустилась, публикация проекта в конфигурации под ОС *Astra Linux* и его финальный запуск прошли успешно.

