# Управление доступом

В Idea Hub реализована многоуровневая система доступа, которая позволяет:
* Разграничивать доступ на уровне модулей и функций.
* Разграничивать доступ на уровне объектов и терминов словарей таксономии. К таким объектам относятся процесс, проект, очередь, робот, машина, лицензия, дашборд.
* Разграничивать доступ на уровне отдельных полей процессов.

Пользователь с ролью **Администратор** имеет полные права на управление Idea Hub, включая просмотр и настройку разрешений для пользователей. Для него не применяются ограничения прав доступа.


Как это работает:
* если доступ к сущности разрешен хотя бы в одном месте (правах или разрешениях), то доступ будет;
* если доступ запрещен в обоих местах, то доступа не будет.

По умолчанию авторизованный пользователь имеет все права на ноды и термины таксономий. В текущем состоянии: чтение + создание + изменение + редактирование.  Пока предлагаем после установки зайти и настроить вручную.


## Доступ на уровне модулей и функций

Доступ на уровне модулей и функций назначается ролям пользователей. Если пользователю назначены несколько ролей, то права доступа этих ролей будут суммироваться.

Настройка прав выполняется в разделе административного меню **Пользователи** на вкладке **Права доступа**. 

**Не используйте** данный раздел для установки прав доступа к терминам таксономии, объектам, а также к полям процессов — для этого существует более другая форма настроек, описанная ниже. Вкладку **Права доступа** рекомендуется использовать только для всех прочих разрешений. Например, если вы хотите определить, каким ролям требуется предоставить права на управление/просмотр учётных записей — соответствующие разрешения сгруппированы в модуле **User**.

На вкладке **Права доступа** в верхней панели отображается перечень существующих ролей, а слева — права доступа, разграниченные по модулям. Для установки разрешений отметьте галочками нужные позиции и сохраните изменения.

![](<../../../idea-hub/resources/admin/users/permissions-tab.png>)


Также только в правах доступа вы можете определить, каким ещё ролям, кроме администратора, будет доступна форма для просмотра и настроек разрешений к терминам таксономии, объектам и полям процессов. За это отвечают права доступа:
* `View Primo Access Rules form` — разрешён просмотр формы правил доступа Primo;
* `Edit Primo Access Rules form` — разрешёно редактирование формы правил доступа Primo.


## Доступ на уровне объектов и словарей таксономии

Администратор может разграничивать доступ к таким объектам, как процесс, проект, очередь, робот, машина, лицензия, дашборд. Кроме того, ему доступна настройка прав доступа к терминам словаря таксономии — например, к терминам словаря департаментов.

Для настройки используются правила доступа, которые определяют разрешённые операции с выбранным объектом или термином словаря. Правила доступа управляют разрешениями на следующие операции:
* **Создать** — разрешено создавать объект/термин словаря таксономии.
* **Обновить** — разрешено изменять объект/термин словаря таксономии.
* **Читать** — разрешено просматривать объект/термин словаря таксономии.
* **Удалить** — разрешено удалять объект/термин словаря таксономии.

Существуют следующие типы правил: 
* **Пользователь** (User) — доступ предоставляется выбранному пользователю.
* **Роль** (Role) — доступ предоставляется выбранной роли пользователя. Следует учитывать, что в списке ролей есть общие роли, например **Авторизованный пользователь** — по умолчанию ею обладают все пользователи, авторизованные в системе, поэтому нет необходимости отдельно назначать такую роль пользователю.
* **То же значение** (SameValue) — доступ предоставляется только тем пользователям, у которых значение выбранного поля совпадает со значением выбранного поля у объекта. Опционально можно выбрать, должны ли совпасть все выбранные значения в этом поле, либо хотя бы одно значение. 
* **Термин таксономии выбранный для пользователя** (Taxonomy term by user reference) — это правило используется только для доступа к терминам таксономии. Доступ предоставляется тем пользователям, у которых в выбранном поле указан данный термин. Опционально можно учитывать все дочерние термины, или всё дерево терминов, в котором состоит данный термин.


Для каждой операции можно настроить несколько правил доступа — в этом случае доступ будет предоставляться тем пользователям, кто соответствует хотя бы одному правилу. Форма с настройками правил доступа имеет одинаковый вид как для объектов, так и для терминов словаря таксономии.

### Пример настройки доступа к объекту

Рассмотрим, как установить правило доступа к такому объекту, как процесс. Например, мы хотим, чтобы просматривать процесс могли все бизнес-аналитики, связанные с этим процессом. 



Для этого:
1. Войдем в Idea Hub с учётной записью администратора.
1. В административном меню выберем раздел **Структура > Типы материалов**.
1. В строке **Процесс** выберем действие **Изменить**.
1. В открывшейся форме редактирования процесса перейдем на вкладку **Контроль доступа**, которая располагается внизу страницы. На вкладке отобразится предварительная информация о существующих настройках.

   ![](<../../../idea-hub/resources/admin/users/access-rules-preview.png>)
   
1. Нажмём **Редактировать правила**. В форме редактирования мы увидим, что для каждой операции правила необходимо настраивать отдельно.
1. Выберем операцию **Читать**, настроим параметры:
   * **Тип правила** — выбираем правило `То же значение`.
   * **Роли с доступом\*** — оставляем значение `Authenticated user`.
   * **Поле пользователя** — выбираем значение `ID пользователя` (машинное имя: uid).
   * **Целевое поле** — выбираем значение `Аналитик` (машинное имя: field_ba).
   * **Соответствие значений** — выбираем значение `По крайней мере одно значение должно соответствовать`. 
1. Внизу страницы нажимаем **Сохранить правила**.


В результате 


   *  у сущности процесса Analyst  и ставим вариант, совпадение хотя бы одного значения + добавляем что это правило действует для всех Авторизованных пользователей.
     

   ![](<../../../idea-hub/resources/admin/users/access-rules-read.png>)
 

3. При выборе "Типа правила" открываются специфические поля для такого правила. 
4. Сохранять обновленные правила обязательно нажатием на кнопку "Сохранить правила" в этом блоке. Не на общую кнопку сохранить на странице.
5. Поскольку перестроение правил доступа занимает значительное время, то после сохранения появится кнопка "Перестроить права доступа". При нажатии запустится процедура, которая обновит все доступы согласно изменениям в правилах. При этом кнопку можно не нажимать, тогда обновление правил доступа произойдёт при следующем запуске крона, а кнопка после этого исчезнет.

В случае, если требуется перестроить права доступа, на странице статуса (/admin/reports/status) будет отображаться подсказка, что требуется перестроить права доступа, и возможность по нажатию кнопки их перестроить, не дожидаясь запуска крона. 


**Пример:** мы хотим, что бы к процессу был доступ у всех бизнес-аналитиков связанных с данным процессом, тогда  выбираем тип правила "SameValue" выбираем у пользователя поле "User Id", у сущности процесса Analyst (field_ba) и ставим вариант, совпадение хотя бы одного значения + добавляем что это правило действует для всех Авторизованных пользователей. 



### Настройка доступа к терминам словаря таксономии








## Доступ на уровне полей процессов

Можно настроить доступы к отдельным полям сущности. В т.ч. разделить кто может создавать, кто редактировать, кто только читать. 


## Управление правами доступа

### Настройка прав доступа

1. В административном меню выберите **Пользователи** и перейдите на вкладу **Роли**.
1. В строке с нужной ролью нажмите стрелочку вниз, которая находится справа от действия **Изменить**.
1. В выпадающем списке выберите **Редактировать права доступа**. Откроется страница **Редактирование роли** — здесь вы можете посмотреть все права доступа данной роли.
1. Отметьте те права доступа, которые вы хотите установить для роли.

   ![](<../../../idea-hub/resources/admin/users/permissions-role.png>)
  
1. Внизу страницы нажмите **Сохранить права доступа**.

### Массовая настройка прав доступа 

Правами доступа можно управлять в разрезе определенной роли или массово для всех существующих ролей. Ниже приведена инструкция по массовому редактированию прав доступа.

1. В административном меню выберите **Пользователи** и перейдите на вкладку **Права доступа**.
1. На странице будет перечень всех возможных прав доступа, которые разграничены по модулям. Отдельные права доступа имеют предупреждения, связанные с безопасностью. 

   ![](<../../../idea-hub/resources/admin/users/permissions-tab.png>)

1. В верхней части страницы перечислены имеющиеся роли в Idea Hub. Для того, чтобы назначить определенной роли право доступа, отметьте его галочкой.
1. Внизу страницы нажмите **Сохранить права доступа**, чтобы изменения применились.



## Управление разрешениями 
Разрешения определяют допустимые операции:
* С объектами Idea Hub. 
* С полями процесса.
* Со словарём таксономии.

По умолчанию просматривать и настраивать разрешения для определённых ролей может только пользователь с ролью **Администратор**. 




### Допустимые операции с объектом
Объектами являются: процесс, проект, очередь, робот, машина, лицензия, дашборд.
* Создание;
* Редактирование любых объектов соответствующего типа;
* Редактирование собственных объектов соответствующего типа;
* Удаление любых объектов соответствующего типа;
* Удаление собственных объектов соответствующего типа;
* Просмотр редакций (*истории правок*) объекта;
* Удаление редакций объекта;
* Восстановление редакций объекта.

Реализовано по отношению к ролям.

### Допустимые операции со словарём таксономии
* Добавить термины
* Удалять термины
* Редактировать термины

Реализовано по отношению к ролям.

### Допустимые операции с полями процесса
Видимость и доступы поля:
* Не установлено. Поле наследует разрешения контента.
* Скрытое. Только автор и администраторы могут видеть и редактировать.
* Пользовательские разрешения. Определить пользовательские разрешения для данного поля.
* Пользовательские разрешения PRIMO. Определить пользовательские разрешения для данного поля:
  * Изменить значение поля
  * Просмотр значения поля
  * Просмотр значения поля по отделу - ??? 


---------------






