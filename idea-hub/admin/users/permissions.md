# Управление доступом

В Idea Hub реализована многоуровневая система доступа, которая позволяет:
* Разграничивать доступ на уровне модулей и функций.
* Разграничивать доступ на уровне объектов и терминов словарей таксономии. К таким объектам относятся процесс, проект, очередь, робот, машина, лицензия, дашборд.
* Разграничивать доступ на уровне отдельных полей процессов.

Пользователь с ролью **Администратор** имеет полные права на управление Idea Hub, включая просмотр и настройку разрешений для пользователей. Для него не применяются ограничения прав доступа.

## Доступ на уровне модулей и функций

Доступ на уровне модулей и функций назначается ролям пользователей. Если пользователю назначены несколько ролей, то права доступа этих ролей будут суммироваться.

Настройка прав выполняется в разделе административного меню **Пользователи** на вкладке **Права доступа**. 

**Не используйте** данный раздел для установки прав доступа к терминам таксономии, объектам, а также к полям процессов — для этого существует более простая форма настроек, описанная ниже. Вкладку **Права доступа** рекомендуется использовать только для всех прочих разрешений. Например, если вы хотите определить, каким ролям разрешить доступ к профилям пользователей — соответствующие разрешения сгруппированы в модуле **User**.

На вкладке **Права доступа** в верхней панели вы увидите перечень существующих ролей, а слева — права доступа, разграниченные по модулям. Для установки разрешений отметьте галочками нужные позиции и сохраните изменения.

![](<../../../idea-hub/resources/admin/users/permissions-tab.png>)


Администратор может назначить права доступа ролям, которым также будет доступна форма для настройки разрешений к терминам таксономии, объектам и полям процессов. 









## Доступ на уровне объектов и словарей таксономии



Для настройки доступа к объектам, полям процесса и терминам таксономии рекомендуется использовать правила. В ближайшем будущем, вероятно ещё и для настройки доступа к профилям пользователя и их полям (но пока этого нет). Для всего остального - права. 

Как это работает:
* если доступ к сущности разрешен хотя бы в одном месте (правах или разрешениях), то доступ будет;
* если доступ запрещен в обоих местах, то доступа не будет.

По умолчанию авторизованный пользователь имеет все права на ноды и термины таксономий. В текущем состоянии: чтение + создание + изменение + редактирование.  Пока предлагаем после установки зайти и настроить вручную.

## Управление правами доступа

### Настройка прав доступа

1. В административном меню выберите **Пользователи** и перейдите на вкладу **Роли**.
1. В строке с нужной ролью нажмите стрелочку вниз, которая находится справа от действия **Изменить**.
1. В выпадающем списке выберите **Редактировать права доступа**. Откроется страница **Редактирование роли** — здесь вы можете посмотреть все права доступа данной роли.
1. Отметьте те права доступа, которые вы хотите установить для роли.

   ![](<../../../idea-hub/resources/admin/users/permissions-role.png>)
  
1. Внизу страницы нажмите **Сохранить права доступа**.

### Массовая настройка прав доступа 

Правами доступа можно управлять в разрезе определенной роли или массово для всех существующих ролей. Ниже приведена инструкция по массовому редактированию прав доступа.

1. В административном меню выберите **Пользователи** и перейдите на вкладку **Права доступа**.
1. На странице будет перечень всех возможных прав доступа, которые разграничены по модулям. Отдельные права доступа имеют предупреждения, связанные с безопасностью. 

   ![](<../../../idea-hub/resources/admin/users/permissions-tab.png>)

1. В верхней части страницы перечислены имеющиеся роли в Idea Hub. Для того, чтобы назначить определенной роли право доступа, отметьте его галочкой.
1. Внизу страницы нажмите **Сохранить права доступа**, чтобы изменения применились.



## Управление разрешениями 
Разрешения определяют допустимые операции:
* С объектами Idea Hub. 
* С полями процесса.
* Со словарём таксономии.

По умолчанию просматривать и настраивать разрешения для определённых ролей может только пользователь с ролью **Администратор**. 

Чтобы указать дополнительные роли, которым будут доступны эти права:
1. В административном меню выберите **Пользователи** и перейдите на вкладку **Права доступа**.
1. Установите выбранным ролям права: 
   * `View Primo Access Rules form` — доступен просмотр формы правил доступа Primo;
   * `Edit Primo Access Rules form` — доступно редактирование формы правил доступа Primo.
1. Нажмите **Сохранить права доступа**.


### Допустимые операции с объектом
Объектами являются: процесс, проект, очередь, робот, машина, лицензия, дашборд.
* Создание;
* Редактирование любых объектов соответствующего типа;
* Редактирование собственных объектов соответствующего типа;
* Удаление любых объектов соответствующего типа;
* Удаление собственных объектов соответствующего типа;
* Просмотр редакций (*истории правок*) объекта;
* Удаление редакций объекта;
* Восстановление редакций объекта.

Реализовано по отношению к ролям.

### Допустимые операции со словарём таксономии
* Добавить термины
* Удалять термины
* Редактировать термины

Реализовано по отношению к ролям.

### Допустимые операции с полями процесса
Видимость и доступы поля:
* Не установлено. Поле наследует разрешения контента.
* Скрытое. Только автор и администраторы могут видеть и редактировать.
* Пользовательские разрешения. Определить пользовательские разрешения для данного поля.
* Пользовательские разрешения PRIMO. Определить пользовательские разрешения для данного поля:
  * Изменить значение поля
  * Просмотр значения поля
  * Просмотр значения поля по отделу - ??? 


---------------


Переработали права доступа к сущностям. Управление стало значительно более гибким. Теперь можно настроить доступы по совпадению значений в полях пользователя и целевой сущности. Можно настроить доступы к отдельным полям сущности. В т.ч. разделить кто может создавать, кто редактировать, кто только читать. 

Изначально блок редактирования прав доступа показывает превью уже сделанных настроек. При нажатии на кнопку "Редактировать правила" раскрывается форма изменения правил. Для каждой операции правила настраиваются отдельно. При выборе "Типа правила" открываются специфические поля для такого правила. Количество типов правил планируется увеличивать по мере необходимости. Сохранять обновленные правила обязательно нажатием на кнопку "Сохранить правила" в этом блоке. Не на общую кнопку сохранить на странице. Поскольку перестроение правил доступа занимает значительное время, то после сохранения появится кнопка "Перестроить права доступа". При нажатии запустится процедура, которая обновит все доступы согласно изменениям в правилах. При этом кнопку можно не нажимать, тогда обновление правил доступа произойдёт при следующем запуске крона, а кнопка после этого исчезнет. Для каждой операции можно настроить несколько правил доступа - в таком случае доступ будет предоставляться тем пользователям, кто соответствует, хотя бы одному правилу.

В случае, если требуется перестроить права доступа, на странице статуса (/admin/reports/status) будет отображаться подсказка, что требуется перестроить права доступа, и возможность по нажатию кнопки их перестроить, не дожидаясь запуска крона. 


Типы правил: 
User (Пользователь) - доступ предоставляется конкретному выбранному пользователю.
Role (Роль пользователя) - доступ предоставляется пользователю обладающему какой-либо ролью пользователя. При в списке есть общие роли, например "Авторизованный пользователь" - такой ролью обладают по умолчанию все пользователи, авторизованные в системе, нет необходимости отдельно назначать такую роль пользователю.
Taxonomy term by user reference (Термин таксономии выбранный для пользователя) - правило только для доступа к терминам таксономии. Доступ предоставляется пользователям у которых в выбранном поле указан данный термин, опционально можно учитывать все дочерние термины, или всё дерево терминов в котором состоит данный термин.
SameValue (То же значение) - доступ предоставляется пользователям у которых значение выбранного поля сходится со значением выбранного поля у сущности. Опционально можно выбрать, должны ли совпасть все выбранные значения в этом поле, либо хотя бы одно значение. 


Пример: мы хотим, что бы к процессу был доступ у всех бизнес-аналитиков связанных с данным процессом, тогда  выбираем тип правила "SameValue" выбираем у пользователя поле "User Id", у сущности процесса Analyst (field_ba) и ставим вариант, совпадение хотя бы одного значения + добавляем что это правило действует для всех Авторизованных пользователей. 



