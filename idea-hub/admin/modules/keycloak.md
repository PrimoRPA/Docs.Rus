# Интеграция с Keycloak

Keycloak — система, которая обеспечивает централизованное управление пользователями, их ролями и правами доступа к данным. Она упрощает администрирование пользователей и их учетных записей, а также позволяет пользователям входить в несколько приложений по одной учетной записи (SSO).

С версии Idea Hub 25.3 появилась возможность интеграции с Keycloak, для чего в расширения Idea Hub был добавлен модуль Keycloak. Модуль позволяет аутентифицировать пользователей на сервере аутентификации Keycloak и синхронизировать поля пользователей с атрибутами OpenID, предоставленными Keycloak.

Ниже приведена инструкция для настройки интеграции Idea Hub с Keycloak.

## Установка модулей в Idea Hub

Установите в Idea Hub модули Keycloak и OpenID Connect. 

Их можно установить командой:
```
drush in keycloak -y
```

Либо через веб-интерфейс Idea Hub:
1. Войдите в Idea Hub с правами администратора.
1. В административном меню выберите пункт **Расширения**.
1. С помощью строки **Фильтр** найдите модули Keycloak, OpenID Connect и поставьте напротив них галочки.
1. Нажмите **Установить** и дождитесь, когда появится уведомление об успешном статусе установки модулей.



## Добавление в Idea Hub клиента Keycloak 

1. Перейдите на страницу `/admin/config/people/openid-connect/add/keycloak`. 
1. В поле **Имя** установите значение `keycloak`.
  
   ***Важно!** Текущая версия модуля учитывает конфигурацию конкретного клиента, поэтому нам доступно только название `keycloak`*.

1. Укажите название клиента (Client ID). В нашем примере это **ideahub**:

   ![keycloak_ideahub.png](/.attachments/keycloak_ideahub-029dabe5-a556-47ad-815e-9c4e67971a3a.png)

1. Укажите значение в поле **Client secret**. У клиента на вкладке credentials это поле есть, его значение выглядит примерно так: **InBPPiGdzYfP9oYrVL3qwTv5BdY1ELtl**

1. Далее нужно указать базовый url keycloak (Keycloak base URL), например наш тестовый keycloak это https://10.0.0.159:8443/

1. Далее нужно указать Keycloak realm, его можно найти в keycloak в самом верху справа (у нас это test)

   ![realm.png](/.attachments/realm-ce1f2021-c579-4e60-b712-dd856fdb4159.png)

1. Дальше я бы посоветовал включить следующие опции "**Update email address in user profile**", "**Enable user role mapping**". Последняя опция позволяет при создании пользователя при логине обновлять его роли.
Например тут я указал что для пользователей keycloak с ролью **role-ideahub** нужно добавлять роль **Бизнес-Пользователь**/

   ![role.png](/.attachments/role-ccd3c5ca-9954-4b58-ab04-970399d3589d.png)

1. После того как всё настроено необходимо нажать кнопку "Сохранить" внизу страницы, а так же сохранить для следующей настройки значение поля Redirect URL

1. Дальше надо перейти на страницу настройки OpenID **/admin/config/people/openid-connect/settings**

1. И включить следующие настройки:  "**Save user claims on every login**", "**Override registration settings**"

1. Предпоследним шагом будет настройки полей "**User claims mapping**". Сейчас можно настроить поля: Изображение, Часовой пояс, Почту, Имя, Телефон.

1. Нажмите **Сохранить конфигурацию** внизу страницы.


## Настройка keycloak

1. На странице редактирования клиента keycloak (в **Ideahub**) ```/admin/config/people/openid-connect/keycloak/edit``` будет url:

   ![url.png](/.attachments/url-3dcbb4a5-4300-4683-adde-c2ecc892fbf8.png)

1. Url сверху который нужно добавить к валидным урлам клиента keycloak (в keycloak):

   * Заходим в нашего клиента:

   ![keycloak_ideahub.png](/.attachments/keycloak_ideahub-029dabe5-a556-47ad-815e-9c4e67971a3a.png)

  * А уже внутри клиента добавляем урл:

   ![url_saved.png](/.attachments/url_saved-88b9a380-692f-454f-ba7a-595cd9401933.png)

