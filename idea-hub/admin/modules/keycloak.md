# Интеграция с Keycloak

Keycloak — система, которая обеспечивает централизованное управление пользователями, их ролями и правами доступа к данным. Она упрощает администрирование пользователей и их учетных записей, а также позволяет пользователям входить в несколько приложений по одной учетной записи (SSO).

В Idea Hub есть возможность настроить вход и регистрацию пользователей через Keycloak. Функциональность появилась в версии 25.3, для чего в расширения Idea Hub был добавлен модуль Keycloak. 

Модуль позволяет аутентифицировать пользователей на сервере аутентификации Keycloak и синхронизировать поля пользователей с атрибутами OpenID, предоставленными Keycloak. Ниже приведена инструкция по настройке данной интеграции.

## Установка модулей 

Установите в Idea Hub модули **Keycloak** и **OpenID Connect**. 

Их можно установить командой:
```
drush in keycloak -y
```

Либо через веб-интерфейс Idea Hub:
1. Войдите в Idea Hub с правами администратора.
1. В административном меню выберите пункт **Расширения**.
1. С помощью строки **Фильтр** найдите модули Keycloak, OpenID Connect и поставьте напротив них галочки.
1. Нажмите **Установить** и дождитесь, когда появится уведомление об успешном статусе установки модулей.



## Добавление клиента Keycloak в Idea Hub  

1. Перейдите на страницу `/admin/config/people/openid-connect/add/keycloak`. 
1. В поле **Имя** установите значение **keycloak**.
  
   ***Важно!** Текущая версия модуля учитывает конфигурацию конкретного клиента, поэтому доступно только название `keycloak`*.

1. Укажите название клиента (Client ID). В нашем примере это **ideahub**:

   !![](<../../../idea-hub/resources/admin/modules/keycloak-client-id.png>)

1. В поле **Client secret** укажите значение, которое можно найти в клиенте на вкладке credentials. Пример значения: **InBPPiGdzYfP9oYrVL3qwTv5BdY1ELtl**

1. Укажите базовый url keycloak (Keycloak base URL). В нашем примере это `https://10.0.0.159:8443/`.
1. Укажите Keycloak realm, который можно найти в keycloak вверху справа. В нашем примере это `test`.

   ![](<../../../idea-hub/resources/admin/modules/>)

1. При необходимости включите опции **Update email address in user profile**, **Enable user role mapping**. Последняя опция позволяет при создании пользователя при логине обновлять его роли.

   Например, тут я указал, что для пользователей keycloak с ролью **role-ideahub** нужно добавлять роль **Бизнес-Пользователь**/

   ![](<../../../>)

1. В завершение нажмите **Сохранить** внизу страницы, а также сохраните для следующей настройки значение поля **Redirect URL**.

1. Перейдите на страницу настройки OpenID: `/admin/config/people/openid-connect/settings`.

1. Включите настройки **Save user claims on every login**, **Override registration settings**.

1. Настройте поля **User claims mapping**. На текущий момент возможно настроить поля: Изображение, Часовой пояс, Почту, Имя, Телефон.

1. В завершение нажмите **Сохранить конфигурацию**.


## Настройка Keycloak

1. На странице редактирования клиента Keycloak в **Ideahub** ```/admin/config/people/openid-connect/keycloak/edit``` будет url:

   ![](<../../../>)

1. Url сверху, который нужно добавить к валидным урлам клиента keycloak (в keycloak):

   * Заходим в нашего клиента:

   ![](<../../../idea-hub/resources/admin/modules/keycloak-client-id.png>)

  * А уже внутри клиента добавляем урл:

   ![](<../../../>)

