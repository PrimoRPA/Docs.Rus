# Подключение к Оркестратору

Подключение к Оркестратору позволяет получить информацию о:
 - проектах, их запусках — время, длительность, общее количество запусков, количество успешных запусков и т.п.;
 - очередях, их запусках — время, длительность, общее количество запусков, количество успешных запусков и т.п.;
 - лицензиях, их использовании/утилизации;
 - департаментах организации;
 - пользователях;
 - роботах;
 - машинах роботов.

Для подключения к Оркестратору в Linux-системах используется скрипт `scripts/orc-data-fetch/get_data.sh`, который входит в комплект поставки Idea Hub. 

Скрипт может запускаться по расписанию с помощью утилиты-планировщика задач cron, позволяющей выполнять скрипты на сервере в назначенное время с заранее определенной периодичностью. Дополнительная информация по работе с cron содержится в документе [Инструкция по работе с cron](https://docs.primo-rpa.ru/primo-rpa/primo-idea-hub/cron).

## Общее описание процесса работы

1. При наступлении времени crontab машины со скриптом запускает скрипт с указанным окружением. 
1. После запуска скрипт создаёт папку для данных этого окружения, подключается в БД Оркестратора, получает данные, складывает их в формате CSV в папку. Рядом с CSV-файлами сохраняется log-файл с процессом получения данных.
1. При запуске cron Idea Hub функционал синхронизации данных проверяет папки, в которых должны быть исходные данные. 
1. Если появились новые файлы из Оркестратора, Idea Hub создаёт таблицы для подходящего окружения и импортирует в них данные из Оркестратора. 
1. Далее Idea Hub запускает обработчик, который трансформирует полученные данные в данные, необходимые Оркестратору, и экспортирует их в указанную папку. 
1. После экспорта обработанных данных запускается миграция данных из Оркестратора, и данные импортируются в Idea Hub. 
1. Idea Hub готов к отображению актуальных данных.

## Требования

* [Psql](https://postgrespro.ru/&sa=D&source=docs&ust=1702476704920204&usg=AOvVaw3K8f-Xb71DoDMk3Cu4xoJm); - неработающая ссылка
* Сron — поставляется по умолчанию во всех системах Linux;
* Менеджер паролей [pass](https://www.passwordstore.org/) (Linux);
* Доступ к серверам, на которых размещены базы данных Оркестратора;
* Пользователь, от имени которого будут выполняться запросы, должен иметь права на чтение следующих баз данных — именно к ним будут обращаться скрипты:  
  * `ltools`
  * `ltoolslicense`

## Настройка скрипта

1. Скрипт должен запускаться на машине, у которой есть доступ к серверам баз данных Оркестратора — по умолчанию это тот же сервер, на котором установлен Idea Hub. На этой машине также должно быть установлено приложение psql.
1. В папке `\scripts\orc-data-fetch` сделайте копию файла `.env.example` с именем `.env`.
1. Проверьте и настройте все переменные в файле `.env`. Если используется несколько окружений, переменные в блоке для окружений (Environments) необходимо продублировать, изменив имена и значения для необходимых окружений. Окружения или контуры — это изолированные подсети внутри общей сети организации. 
1. Скрипт запускается с аргументом — именем окружения. Например: `./get_data.sh prod`, `./get_data.sh test` и т.п.
1. Запуск скрипта отдельно для каждого окружения добавьте в crontab. Пример строки crontab, которая описывает запуск скриптов 1 в 3 часа 10 минут каждый день:
   ```
   10 3 * * * /var/www/ideahub/scripts/orc-data-fetch/get_data.sh prod > /dev/null 2>&1
   ```
1. В crontab так же необходимо добавить строку:
   ```
   */5 * * * * cd /var/www/ideahub && /var/www/ideahub/vendor/bin/drush cron > /dev/null 2>&1
   ``` 
1. Файл `scripts/orc-data-fetch/.env.example` содержит дополнительную информацию о настройках.

## Параметры скрипта

### Общие (глобальные) установки

- `LOG_FILE_MAX_SIZE=1048576` — максимальный размер файла логов. При достижении этого размера файл будет очищен.
- `USE_PASS=0` — переменная, которая указывает, следует ли использовать утилиту pass. Возможные значения:
   - 0 — пароль будет использоваться в том виде, в котором он указан в переменной вида DB\_PASS\_[ИМЯ\_БАЗЫ\_ДАННЫХ]\_[ИМЯ_ОКРУЖЕНИЯ].
   - 1 — в переменных вида DB\_PASS\_[ИМЯ\_БАЗЫ\_ДАННЫХ]\_[ИМЯ_ОКРУЖЕНИЯ] укажите имя, под которым пароль хранится в утилите pass. 
- `LANGUAGE=RU` — используемый язык скрипта. Возможные значения: RU, EN.
- `OUTPUT_FOLDER=<рабочий каталог проекта>/private/import-source/sync` — переменная с каталогом, в который будут записаны результирующие файлы. НЕ СТАВЬТЕ косую черту (слеш) в конце строки. Желательно использовать абсолютный путь.
- `QUERY_LIMIT=20000` — максимальное количество записей, которые будут выгружаться за один запрос.

- Интервал в днях, за который будут получаться данные из таблицы RpaProjectLaunches.
`RPA_PROJECT_LAUNCHES_INTERVAL=5`
`RPA_PROJECT_LAUNCHES_FIRST_TIME_INTERVAL=300`

### Переменные окружения

Все переменные ниже задаются для каждого контура отдельно, с суффиксом в виде имени этого контура. Необязательно использовать имя PROD — замените его на имя вашего контура. 

Переменные:
* SLEEP_DURATION_[ENVIRONMENT]=0 — пауза в секундах перед повторным запросом в таблицу, если записей больше, чем указано в QUERY_LIMIT.

  Пример использования для разных окружений:
  * `SLEEP_DURATION_PROD=0`
  * `SLEEP_DURATION_TEST=30`

* DB\_[VAR]\_[DB_NAME]_[ENVIRONMENT]=reader

  Пример использования для разных окружений:
  * `DB_NAME_LTOOLS_PROD=ltools`
  * `DB_PASS_LTOOLSLICENSE_TEST=postgres`

**Пример для окружения PROD:**

Credentials: NAME, HOST, PORT, USER, PASS
```
DB_[VAR]_[DB_NAME]_[ENVIRONMENT]
DB_NAME_LTOOLS_PROD=ltools
DB_HOST_LTOOLS_PROD=127.0.0.1
DB_PORT_LTOOLS_PROD=5432
DB_USER_LTOOLS_PROD=postgres
DB_PASS_LTOOLS_PROD=postgres

DB_NAME_LTOOLSLICENSE_PROD=ltoolslicense
DB_HOST_LTOOLSLICENSE_PROD=127.0.0.1
DB_PORT_LTOOLSLICENSE_PROD=5432
DB_USER_LTOOLSLICENSE_PROD=postgres
DB_PASS_LTOOLSLICENSE_PROD=postgres
```

## Настройка Idea Hub

1. В файле `config/settings.local.php` добавьте/измените переменные в блоке `Orch sync data variable`.
1. `orch_raw_data_source_path` — каталог, в который скрипт складывает данные из Оркестратора. В общем случае это тот каталог, который указывался при настройке скрипта в файле `.env` в параметре OUTPUT_FOLDER. Каталог по умолчанию: `private://import-source/orch-sync`
1. `orch_raw_data_target_path` — каталог, в который Idea Hub положит CSV-файлы после обработки и подготовки данных из Оркестратора для синхронизации. По умолчанию это `private://import-source/environments`.

