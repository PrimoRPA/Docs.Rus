# Подключение к Оркестратору

Подключение к Оркестратору позволяет получить информацию о:
 - проектах, их запусках — дата, средняя длительность, общее количество запусков, количество успешных запусков, количество бизнес-ошибок и количество технических ошибок.
 - очередях, статистику обработки элементов — дата, средняя длительность, общее количество обработанных элементов, количество успешно обработанных элементов, // количество бизнес-ошибок и количество технических ошибок. (исправить)
 - лицензиях и типах лицензий;
 - роботах;
 - машинах роботов.

Для подключения к Оркестратору в Linux-системах используется скрипт `scripts/orc-data-fetch/get_data.sh`, который входит в комплект поставки Idea Hub. 

Скрипт может запускаться по расписанию с помощью утилиты-планировщика задач cron, позволяющей выполнять скрипты на сервере в назначенное время с заранее определенной периодичностью. Дополнительная информация по работе с cron содержится в документе [Инструкция по работе с cron](https://docs.primo-rpa.ru/primo-rpa/primo-idea-hub/cron).

## Общее описание процесса получения данных из Оркестратора

Описать, как устроен `get_data.sh` и что где настраивается: с помощью скрипта подключаемся к БД Оркестратора, создаёт папку для данных этого окружения, получает данные, складывает их в формате CSV в папку контура. Рядом с CSV-файлами сохраняется log-файл с процессом получения данных.

1. Скрипт `get_data.sh` запускается по cron (и в соответствии с настройками)
1. Idea Hub запускается по cron, забирает данные из каталогов контуров (контуры и время указываются при создании контура в интерфейсе). Время должно быть позже.
1. Idea Hub готов к отображению актуальных данных.

//
1. Запускается по cron get_data.sh
2. Запускается по cron Idea Hub (время запуска IDea Hub должно быть позже, чем время запуска get_data.sh)
3. И больше ничего не нужно делать


## Требования 

Ниже указаны требования к машине, на которой будет запускаться скрипт `get_data.sh` - это не та же машина, на которой установлен Идеа Хаб?

Машина должна иметь доступ к серверам баз данных Оркестратора — по умолчанию это тот же сервер, на котором установлен Idea Hub. На этой машине также должно быть установлено приложение psql.

Требования:
* [Psql](https://postgrespro.ru/&sa=D&source=docs&ust=1702476704920204&usg=AOvVaw3K8f-Xb71DoDMk3Cu4xoJm); - неработающая ссылка
* Сron — поставляется по умолчанию во всех системах Linux;
* Менеджер паролей [pass](https://www.passwordstore.org/) (Linux);
* Доступ к серверам, на которых размещены базы данных Оркестратора;
* Пользователь, от имени которого будут выполняться запросы, должен иметь права на чтение следующих баз данных — именно к ним будет обращаться скрипт:  
  * `ltools` - указать какие таблицы (только селект)
  * `ltoolslicense` - указать какие таблицы (только селект)
 

## Настройка скрипта get_data.sh
1. В папке `\scripts\orc-data-fetch` сделайте копию файла `.env.example` с именем `.env`.
1. Проверьте и настройте все переменные в файле `.env`. Окружения или контуры — это изолированные подсети внутри общей сети организации. Если используется несколько контуров, переменные в блоке для контуров (Environments) необходимо продублировать, изменив имена и значения для необходимых контуров. 
1. Скрипт запускается с аргументом — именем контура. Например: `./get_data.sh prod`, `./get_data.sh test` и т.п.
1. Запуск скрипта отдельно для каждого контура добавьте в crontab. Пример строки crontab, которая описывает запуск скриптов 1 в 3 часа 10 минут каждый день:
   ```
   10 3 * * * /var/www/ideahub/scripts/orc-data-fetch/get_data.sh prod > /dev/null 2>&1
   ```
1. В crontab также необходимо добавить строку:
   ```
   */5 * * * * cd /var/www/ideahub && /var/www/ideahub/vendor/bin/drush cron > /dev/null 2>&1
   ``` 
1. Файл `scripts/orc-data-fetch/.env.example` содержит дополнительную информацию о настройках.

## Параметры скрипта get_data.sh

### Глобальные параметры

- `LOG_FILE_MAX_SIZE=1048576` — максимальный размер файла логов. При достижении этого размера файл будет очищен.
- `USE_PASS=0` — переменная, которая указывает, следует ли использовать утилиту pass. Возможные значения:
   - 0 — пароль будет использоваться в том виде, в котором он указан в переменной вида DB\_PASS\_[ИМЯ\_БАЗЫ\_ДАННЫХ]\_[ИМЯ_ОКРУЖЕНИЯ].
   - 1 — в переменных вида DB\_PASS\_[ИМЯ\_БАЗЫ\_ДАННЫХ]\_[ИМЯ_ОКРУЖЕНИЯ] укажите имя, под которым пароль хранится в утилите pass. 
- `LANGUAGE=RU` — используемый язык скрипта. Возможные значения: RU, EN.
- `OUTPUT_FOLDER=<рабочий каталог проекта>/private/import-source/sync` — переменная с каталогом, в который будут записаны результирующие файлы. НЕ СТАВЬТЕ косую черту (слеш) в конце строки. Желательно использовать абсолютный путь.
- `QUERY_LIMIT=20000` — максимальное количество записей, которые будут выгружаться за один запрос.

- Интервал в днях, за который будут получаться данные из таблицы RpaProjectLaunches.
`RPA_PROJECT_LAUNCHES_INTERVAL=5`
`RPA_PROJECT_LAUNCHES_FIRST_TIME_INTERVAL=300`

### Переменные окружения

Все переменные ниже задаются для каждого контура отдельно, с суффиксом в виде имени этого контура. Необязательно использовать имя PROD — замените PROD на имя вашего контура. 

* SLEEP_DURATION_[ENVIRONMENT]=0 — пауза в секундах перед повторным запросом в таблицу, если записей больше, чем указано в QUERY_LIMIT.

  Пример использования для разных контуров:
  * `SLEEP_DURATION_PROD=0`
  * `SLEEP_DURATION_TEST=30`

* DB\_[VAR]\_[DB_NAME]_[ENVIRONMENT]=reader — ...

  Пример использования для разных контуров:
  * `DB_NAME_LTOOLS_PROD=ltools`
  * `DB_PASS_LTOOLSLICENSE_TEST=postgres`

**Пример заполнения для контура PROD:**

Учетные данные для подключения к базе данных (credentials): 
* NAME — имя базы данных.
* HOST — IP-адрес сервера, на котором расположена база данных.
* PORT — порт подключения к базе данных.
* USER — имя пользователя для базы данных.
* PASS — пароль пользователя для базы данных.
```
DB_[VAR]_[DB_NAME]_[ENVIRONMENT]
DB_NAME_LTOOLS_PROD=ltools
DB_HOST_LTOOLS_PROD=127.0.0.1
DB_PORT_LTOOLS_PROD=5432
DB_USER_LTOOLS_PROD=postgres
DB_PASS_LTOOLS_PROD=postgres

DB_NAME_LTOOLSLICENSE_PROD=ltoolslicense
DB_HOST_LTOOLSLICENSE_PROD=127.0.0.1
DB_PORT_LTOOLSLICENSE_PROD=5432
DB_USER_LTOOLSLICENSE_PROD=postgres
DB_PASS_LTOOLSLICENSE_PROD=postgres
```

## Настройка Idea Hub

1. В файле `config/settings.local.php` добавьте/измените переменные в блоке `Orch sync data variable`.
1. `orch_raw_data_source_path` — каталог, в который скрипт складывает данные из Оркестратора. В общем случае это тот каталог, который указывался при настройке скрипта в файле `.env` в параметре OUTPUT_FOLDER. Каталог по умолчанию: `private://import-source/orch-sync`
1. `orch_raw_data_target_path` — каталог, в который Idea Hub положит CSV-файлы после обработки и подготовки данных из Оркестратора для синхронизации. По умолчанию это `private://import-source/environments`.

